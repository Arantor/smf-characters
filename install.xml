<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">
<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
	<id>Arantor:Characters</id>
	<version>1.0</version>

	<!-- Get the current user's character -->
	<file name="$sourcedir/Load.php">
		<!-- Actually get the data -->
		<operation>
			<search position="replace"><![CDATA[
			$request = $smcFunc['db_query']('', '
				SELECT mem.*, COALESCE(a.id_attach, 0) AS id_attach, a.filename, a.attachment_type
				FROM {db_prefix}members AS mem
					LEFT JOIN {db_prefix}attachments AS a ON (a.id_member = {int:id_member})
				WHERE mem.id_member = {int:id_member}
				LIMIT 1',
				array(
					'id_member' => $id_member,
				)
			);
			$user_settings = $smcFunc['db_fetch_assoc']($request);]]></search>
			<add><![CDATA[
			$request = $smcFunc['db_query']('', '
				SELECT mem.*, chars.id_character, chars.character_name, chars.avatar AS char_avatar, chars.signature AS char_signature,
					chars.id_theme AS char_theme, chars.is_main, chars.main_char_group, chars.char_groups, COALESCE(a.id_attach, 0) AS id_attach, a.filename, a.attachment_type
				FROM {db_prefix}members AS mem
					LEFT JOIN {db_prefix}attachments AS a ON (a.id_member = {int:id_member})
					LEFT JOIN {db_prefix}characters AS chars ON (chars.id_character = mem.current_character)
				WHERE mem.id_member = {int:id_member}
				LIMIT 1',
				array(
					'id_member' => $id_member,
				)
			);
			$user_settings = $smcFunc['db_fetch_assoc']($request);
			$user_settings['id_theme'] = $user_settings['char_theme'];]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
	if (!empty($new_loaded_ids) && $set !== 'minimal')
	{]]></search>
			<add><![CDATA[
	if (!empty($new_loaded_ids) && $set !== 'minimal')
	{
		foreach ($new_loaded_ids as $new_id)
		{
			// We might need to juggle the colours around - but only for
			// non main characters. Main will inherit the account so no
			// changes required. This is to fix things like who's online
			// colour; we'll have to fix icon display elsewhere separately.
			if (empty($user_profile[$new_id]['is_main']))
			{
				$user_profile[$new_id]['member_group_color'] = $user_profile[$new_id]['char_group_color'];
				$user_profile[$new_id]['member_group'] = $user_profile[$new_id]['character_group'];
			}
		}
		$request = $smcFunc['db_query']('', '
			SELECT id_member, id_character, character_name, avatar, signature, id_theme, posts, age, date_created,
				last_active, is_main, main_char_group, char_groups
			FROM {db_prefix}characters
			WHERE id_member IN ({array_int:loaded_ids})
			ORDER BY NULL',
			array(
				'loaded_ids' => $new_loaded_ids,
			)
		);
		while ($row = $smcFunc['db_fetch_assoc']($request))
			$user_profile[$row['id_member']]['characters'][$row['id_character']] = array(
				'id_character' => $row['id_character'],
				'character_name' => $row['character_name'],
				'character_url' => '?action=profile;u=' . $row['id_member'] . ';area=characters;char=' . $row['id_character'],
				'avatar' => $row['avatar'],
				'signature' => $row['signature'],
				'sig_parsed' => !empty($row['signature']) ? parse_bbc($row['signature'], true, 'sig_char_' . $row['id_character']) : '',
				'id_theme' => $row['id_theme'],
				'posts' => $row['posts'],
				'age' => $row['age'],
				'date_created' => $row['date_created'],
				'last_active' => $row['last_active'],
				'is_main' => $row['is_main'],
				'main_char_group' => $row['main_char_group'],
				'char_groups' => $row['char_groups'],
			);
		$smcFunc['db_free_result']($request);

		foreach ($user_profile as $id_member => $member)
		{
			if (!isset($member['characters'])) {
				$user_profile[$id_member]['characters'] = array();
			} else {
				uasort($user_profile[$id_member]['characters'], function ($a, $b) {
					return $a['character_name'] > $b['character_name'] ? 1 : ($a['character_name'] < $a['character_name'] ? -1 : 0);
				});
			}
		}]]></add>
		</operation>
	</file>

	<!-- Make sure we push the current character id into the log when we fill it generally -->
	<file name="$sourcedir/Logging.php">
		<operation>
			<search position="replace"><![CDATA[
		$smcFunc['db_insert']($do_delete ? 'ignore' : 'replace',
			'{db_prefix}log_online',
			array('session' => 'string', 'id_member' => 'int', 'id_spider' => 'int', 'log_time' => 'int', 'ip' => 'raw', 'url' => 'string'),
			array($session_id, $user_info['id'], empty($_SESSION['id_robot']) ? 0 : $_SESSION['id_robot'], time(), 'COALESCE(INET_ATON(\'' . $user_info['ip'] . '\'), 0)', $serialized),
			array('session')
		);]]></search>
			<add><![CDATA[
		$smcFunc['db_insert']($do_delete ? 'ignore' : 'replace',
			'{db_prefix}log_online',
			array('session' => 'string', 'id_member' => 'int', 'id_character' => 'int', 'id_spider' => 'int', 'log_time' => 'int', 'ip' => 'raw', 'url' => 'string'),
			array($session_id, $user_info['id'], $user_info['id_character'], empty($_SESSION['id_robot']) ? 0 : $_SESSION['id_robot'], time(), 'COALESCE(INET_ATON(\'' . $user_info['ip'] . '\'), 0)', $serialized),
			array('session')
		);]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
		$user_settings['total_time_logged_in'] += time() - $_SESSION['timeOnlineUpdated'];]]></search>
			<add><![CDATA[
		$user_settings['total_time_logged_in'] += time() - $_SESSION['timeOnlineUpdated'];
		$smcFunc['db_query']('', '
			UPDATE {db_prefix}characters
			SET last_active = {int:last_active}
			WHERE id_character = {int:character}',
			array(
				'last_active' => time(),
				'character' => $user_info['id_character'],
			)
		);]]></add>
		</operation>
	</file>
	<file name="$sourcedir/Who.php">
		<operation>
			<search position="replace"><![CDATA[
		SELECT
			lo.log_time, lo.id_member, lo.url, INET_NTOA(lo.ip) AS ip, mem.real_name,
			lo.session, mg.online_color, COALESCE(mem.show_online, 1) AS show_online,
			lo.id_spider
		FROM {db_prefix}log_online AS lo
			LEFT JOIN {db_prefix}members AS mem ON (lo.id_member = mem.id_member)
			LEFT JOIN {db_prefix}membergroups AS mg ON (mg.id_group = CASE WHEN mem.id_group = {int:regular_member} THEN mem.id_post_group ELSE mem.id_group END)' . (!empty($conditions) ? ']]></search>
			<add><![CDATA[
		SELECT
			lo.log_time, lo.id_member, lo.url, INET_NTOA(lo.ip) AS ip, lo.id_character, COALESCE(chars.character_name, mem.real_name) AS real_name,
			lo.session, IF(chars.is_main, mg.online_color, cg.online_color) AS online_color, COALESCE(mem.show_online, 1) AS show_online,
			lo.id_spider
		FROM {db_prefix}log_online AS lo
			LEFT JOIN {db_prefix}members AS mem ON (lo.id_member = mem.id_member)
			LEFT JOIN {db_prefix}membergroups AS mg ON (mg.id_group = CASE WHEN mem.id_group = {int:regular_member} THEN mem.id_post_group ELSE mem.id_group END)
			LEFT JOIN {db_prefix}characters AS chars ON (lo.id_character = chars.id_character)
			LEFT JOIN {db_prefix}membergroups AS cg ON (chars.main_char_group = cg.id_group)' . (!empty($conditions) ? ']]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
		$context['members'][$row['session']] = array(
			'id' => $row['id_member'],]]></search>
			<add><![CDATA[
		$context['members'][$row['session']] = array(
			'id_character' => $row['id_character'],
			'id' => $row['id_member'],]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
			$context['members'][$i] += $memberContext[$member['id']];
	}]]></search>
			<add><![CDATA[
			$context['members'][$i] += $memberContext[$member['id']];

		if (!empty($member['id_character']) && !empty($context['members'][$i]['characters'][$member['id_character']]))
		{
			// Need to 'fix' a few things.
			$character = $context['members'][$i]['characters'][$member['id_character']];
			$context['members'][$i]['name'] = $character['character_name'];
			$context['members'][$i]['href'] .= ';area=characters;char=' . $member['id_character'];
		}
	}]]></add>
		</operation>
	</file>
	<file name="$sourcedir/Subs-MembersOnline.php">
		<operation>
			<search position="replace"><![CDATA[
	$request = $smcFunc['db_query']('', '
		SELECT
			lo.id_member, lo.log_time, lo.id_spider, mem.real_name, mem.member_name, mem.show_online,
			mg.online_color, mg.id_group, mg.group_name
		FROM {db_prefix}log_online AS lo
			LEFT JOIN {db_prefix}members AS mem ON (mem.id_member = lo.id_member)
			LEFT JOIN {db_prefix}membergroups AS mg ON (mg.id_group = CASE WHEN mem.id_group = {int:reg_mem_group} THEN mem.id_post_group ELSE mem.id_group END)',]]></search>
			<add><![CDATA[
	$request = $smcFunc['db_query']('', '
		SELECT
			lo.id_member, lo.log_time, lo.id_spider, chars.id_character, IFNULL(chars.character_name, mem.real_name) AS real_name, mem.member_name, mem.show_online,
			IF(chars.is_main, mg.online_color, cg.online_color) AS online_color, mg.id_group, mg.group_name
		FROM {db_prefix}log_online AS lo
			LEFT JOIN {db_prefix}members AS mem ON (mem.id_member = lo.id_member)
			LEFT JOIN {db_prefix}membergroups AS mg ON (mg.id_group = CASE WHEN mem.id_group = {int:reg_mem_group} THEN mem.id_post_group ELSE mem.id_group END)
			LEFT JOIN {db_prefix}characters AS chars ON (lo.id_character = chars.id_character)
			LEFT JOIN {db_prefix}membergroups AS cg ON (cg.id_group = chars.main_char_group)',]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
		// Some basic color coding...
		if (!empty($row['online_color']))
			$link = '<a href="' . $scripturl . '?action=profile;u=' . $row['id_member'] . '" style="color: ' . $row['online_color'] . ';">' . $row['real_name'] . '</a>';
		else
			$link = '<a href="' . $scripturl . '?action=profile;u=' . $row['id_member'] . '">' . $row['real_name'] . '</a>';]]></search>
			<add><![CDATA[
		// Some basic color coding...
		if (!empty($row['online_color']))
			$link = '<a href="' . $scripturl . '?action=profile;u=' . $row['id_member'] . (!empty($row['id_character']) ? ';area=characters;char=' . $row['id_character'] : '') . '" style="color: ' . $row['online_color'] . ';">' . $row['real_name'] . '</a>';
		else
			$link = '<a href="' . $scripturl . '?action=profile;u=' . $row['id_member'] . (!empty($row['id_character']) ? ';area=characters;char=' . $row['id_character'] : '') . '">' . $row['real_name'] . '</a>';]]></add>
		</operation>
	</file>
	<file name="$sourcedir/Display.php">
		<operation>
			<search position="replace"><![CDATA[
			SELECT
				lo.id_member, lo.log_time, mem.real_name, mem.member_name, mem.show_online,
				mg.online_color, mg.id_group, mg.group_name
			FROM {db_prefix}log_online AS lo
				LEFT JOIN {db_prefix}members AS mem ON (mem.id_member = lo.id_member)
				LEFT JOIN {db_prefix}membergroups AS mg ON (mg.id_group = CASE WHEN mem.id_group = {int:reg_id_group} THEN mem.id_post_group ELSE mem.id_group END)]]></search>
			<add><![CDATA[
			SELECT
				lo.id_member, lo.log_time, chars.id_character, IFNULL(chars.character_name, mem.real_name) AS real_name, mem.member_name, mem.show_online,
				IF(chars.is_main, mg.online_color, cg.online_color) AS online_color, mg.id_group, mg.group_name
			FROM {db_prefix}log_online AS lo
				LEFT JOIN {db_prefix}members AS mem ON (mem.id_member = lo.id_member)
				LEFT JOIN {db_prefix}membergroups AS mg ON (mg.id_group = CASE WHEN mem.id_group = {int:reg_id_group} THEN mem.id_post_group ELSE mem.id_group END)
				LEFT JOIN {db_prefix}characters AS chars ON (lo.id_character = chars.id_character)
				LEFT JOIN {db_prefix}membergroups AS cg ON (cg.id_group = chars.main_char_group)]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
			if (!empty($row['online_color']))
				$link = '<a href="' . $scripturl . '?action=profile;u=' . $row['id_member'] . '" style="color: ' . $row['online_color'] . ';">' . $row['real_name'] . '</a>';
			else
				$link = '<a href="' . $scripturl . '?action=profile;u=' . $row['id_member'] . '">' . $row['real_name'] . '</a>';]]></search>
			<add><![CDATA[
			if (!empty($row['online_color']))
				$link = '<a href="' . $scripturl . '?action=profile;u=' . $row['id_member'] . (!empty($row['id_character']) ? ';area=characters;char=' . $row['id_character'] : '') . '" style="color: ' . $row['online_color'] . ';">' . $row['real_name'] . '</a>';
			else
				$link = '<a href="' . $scripturl . '?action=profile;u=' . $row['id_member'] . (!empty($row['id_character']) ? ';area=characters;char=' . $row['id_character'] : '') . '">' . $row['real_name'] . '</a>';]]></add>
		</operation>
	</file>
	<file name="$sourcedir/MessageIndex.php">
		<operation>
			<search position="replace"><![CDATA[
			SELECT
				lo.id_member, lo.log_time, mem.real_name, mem.member_name, mem.show_online,
				mg.online_color, mg.id_group, mg.group_name
			FROM {db_prefix}log_online AS lo
				LEFT JOIN {db_prefix}members AS mem ON (mem.id_member = lo.id_member)
				LEFT JOIN {db_prefix}membergroups AS mg ON (mg.id_group = CASE WHEN mem.id_group = {int:reg_member_group} THEN mem.id_post_group ELSE mem.id_group END)]]></search>
			<add><![CDATA[
			SELECT
				lo.id_member, lo.log_time, chars.id_character, IFNULL(chars.character_name, mem.real_name) AS real_name, mem.member_name, mem.show_online,
				IF(chars.is_main, mg.online_color, cg.online_color) AS online_color, mg.id_group, mg.group_name
			FROM {db_prefix}log_online AS lo
				LEFT JOIN {db_prefix}members AS mem ON (mem.id_member = lo.id_member)
				LEFT JOIN {db_prefix}membergroups AS mg ON (mg.id_group = CASE WHEN mem.id_group = {int:reg_member_group} THEN mem.id_post_group ELSE mem.id_group END)
				LEFT JOIN {db_prefix}characters AS chars ON (lo.id_character = chars.id_character)
				LEFT JOIN {db_prefix}membergroups AS cg ON (cg.id_group = chars.main_char_group)]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
			if (!empty($row['online_color']))
				$link = '<a href="' . $scripturl . '?action=profile;u=' . $row['id_member'] . '" style="color: ' . $row['online_color'] . ';">' . $row['real_name'] . '</a>';
			else
				$link = '<a href="' . $scripturl . '?action=profile;u=' . $row['id_member'] . '">' . $row['real_name'] . '</a>';]]></search>
			<add><![CDATA[
			if (!empty($row['online_color']))
				$link = '<a href="' . $scripturl . '?action=profile;u=' . $row['id_member'] . (!empty($row['id_character']) ? ';area=characters;char=' . $row['id_character'] : '') . '" style="color: ' . $row['online_color'] . ';">' . $row['real_name'] . '</a>';
			else
				$link = '<a href="' . $scripturl . '?action=profile;u=' . $row['id_member'] . (!empty($row['id_character']) ? ';area=characters;char=' . $row['id_character'] : '') . '">' . $row['real_name'] . '</a>';]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
						'href' => !empty($row['first_id_member']) ? $scripturl . '?action=profile;u=' . $row['first_id_member'] : '',
						'link' => !empty($row['first_id_member']) ? '<a href="' . $scripturl . '?action=profile;u=' . $row['first_id_member'] . '" title="' . $txt['profile_of'] . ' ' . $row['first_display_name'] . '" class="preview">' . $row['first_display_name'] . '</a>' : $row['first_display_name']]]></search>
			<add><![CDATA[
						'href' => !empty($row['first_id_member']) ? $scripturl . '?action=profile;u=' . $row['first_id_member'] : '',
						'link' => !empty($row['first_id_member']) ? '<a href="' . $scripturl . '?action=profile;u=' . $row['first_id_member'] . (!empty($row['first_character']) ? ';area=characters;char=' . $row['first_character'] : '') . '" title="' . $txt['profile_of'] . ' ' . $row['first_display_name'] . '" class="preview">' . $row['first_display_name'] . '</a>' : $row['first_display_name']]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
						'href' => !empty($row['last_id_member']) ? $scripturl . '?action=profile;u=' . $row['last_id_member'] : '',
						'link' => !empty($row['last_id_member']) ? '<a href="' . $scripturl . '?action=profile;u=' . $row['last_id_member'] . '">' . $row['last_display_name'] . '</a>' : $row['last_display_name']]]></search>
			<add><![CDATA[
						'href' => !empty($row['last_id_member']) ? $scripturl . '?action=profile;u=' . $row['last_id_member'] : '',
						'link' => !empty($row['last_id_member']) ? '<a href="' . $scripturl . '?action=profile;u=' . $row['last_id_member'] . (!empty($row['last_character']) ? ';area=characters;char=' . $row['last_character'] : '') . '">' . $row['last_display_name'] . '</a>' : $row['last_display_name']]]></add>
		</operation>
	</file>

	<!-- The user's menu -->
	<file name="$themedir/index.template.php">
		<operation>
			<search position="replace"><![CDATA[
		// Secondly, PMs if we're doing them]]></search>
			<add><![CDATA[
		echo '
			<li>
				<a href="', $scripturl, '?action=profile;area=characters" id="characters_menu_top" onclick="return false;">
				', sprintf($txt['posting_as'], $GLOBALS['user_info']['character_name']), ' &#9660;</a>
				<div id="characters_menu" class="top_menu"></div>
			</li>';

		// Secondlyish, PMs if we're doing them]]></add>
		</operation>
	</file>

	<!-- Adding character details to saving -->
	<file name="$sourcedir/Post.php">
		<operation>
			<search position="replace"><![CDATA[
	$posterOptions = array(
		'id' => $user_info['id'],]]></search>
			<add><![CDATA[
	$posterOptions = array(
		'id' => $user_info['id'],
		'char_id' => $user_info['id_character'],]]></add>
		</operation>
	</file>

	<!-- Fix poster counts when approving posts -->
	<file name="$sourcedir/Subs-Post.php">
		<operation>
			<search position="replace"><![CDATA[topic_approved, b.count_posts]]></search>
			<add><![CDATA[topic_approved, b.count_posts, m.id_character]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
	$member_post_changes = array();]]></search>
			<add><![CDATA[
	$member_post_changes = array();
	$char_post_changes = array();]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
		// Post count for the user?
		if ($row['id_member'] && empty($row['count_posts']))
			$member_post_changes[$row['id_member']] = isset($member_post_changes[$row['id_member']]) ? $member_post_changes[$row['id_member']] + 1 : 1;]]></search>
			<add><![CDATA[
		// Post count for the user?
		if ($row['id_member'] && empty($row['count_posts']))
		{
			$member_post_changes[$row['id_member']] = isset($member_post_changes[$row['id_member']]) ? $member_post_changes[$row['id_member']] + 1 : 1;
			$char_post_changes[$row['id_character']] = isset($char_post_changes[$row['id_character']]) ? $char_post_changes[$row['id_character']] + 1 : 1;
			
		}]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
	// Post count for the members?
	if (!empty($member_post_changes))
		foreach ($member_post_changes as $id_member => $count_change)
			updateMemberData($id_member, array('posts' => 'posts ' . ($approve ? '+' : '-') . ' ' . $count_change));]]></search>
			<add><![CDATA[
	// Post count for the members?
	if (!empty($member_post_changes))
		foreach ($member_post_changes as $id_member => $count_change)
			updateMemberData($id_member, array('posts' => 'posts ' . ($approve ? '+' : '-') . ' ' . $count_change));
	if (!empty($char_post_changes))
		foreach ($char_post_changes as $id_char => $count_change)
			updateCharacterData($id_char, array('posts' => 'posts ' . ($approve ? '+' : '-') . ' ' . $count_change));]]></add>
		</operation>
	</file>

	<!-- Now display the character poster -->
	<file name="$themedir/Display.template.php">
		<operation>
			<search position="replace"><![CDATA[
	// Show the user's avatar.
	if (!empty($modSettings['show_user_images']) && empty($options['show_no_avatars']) && !empty($message['member']['avatar']['image']))
		echo '
								<li class="avatar">
									<a href="', $scripturl, '?action=profile;u=', $message['member']['id'], '">', $message['member']['avatar']['image'], '</a>
								</li>';]]></search>
			<add><![CDATA[
	// Show the user's avatar.
	if (!empty($modSettings['show_user_images']) && empty($options['show_no_avatars']))
	{
		if (isset($message['member']['characters'][$message['id_character']]))
		{
			$character = $message['member']['characters'][$message['id_character']];
			$profile_link = $character['character_url'];
		}
		else
			$profile_link = '?action=profile;u=' . $message['member']['id'];

		if (!empty($message['member']['avatar']['image']))
		{
			echo '
								<li class="avatar">
									<a href="', $scripturl, $profile_link, '">', $message['member']['avatar']['image'], '</a>
								</li>';
		}
	}]]></add>
		</operation>
	</file>
	<file name="$sourcedir/Post.php">
		<operation>
			<search position="replace"><![CDATA[
		SELECT
			COALESCE(mem.real_name, m.poster_name) AS poster_name, m.poster_time,
			m.body, m.smileys_enabled, m.id_msg, m.id_member
		FROM {db_prefix}messages AS m
			LEFT JOIN {db_prefix}members AS mem ON (mem.id_member = m.id_member)]]></search>
			<add><![CDATA[
		SELECT
			COALESCE(chars.character_name, mem.real_name, m.poster_name) AS poster_name, m.poster_time,
			m.body, m.smileys_enabled, m.id_msg, m.id_member
		FROM {db_prefix}messages AS m
			LEFT JOIN {db_prefix}members AS mem ON (mem.id_member = m.id_member)
			LEFT JOIN {db_prefix}characters AS chars ON (chars.id_character = m.id_character)]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
		SELECT COALESCE(mem.real_name, m.poster_name) AS poster_name, m.poster_time, m.body, m.id_topic, m.subject,
			m.id_board, m.id_member, m.approved
		FROM {db_prefix}messages AS m
			INNER JOIN {db_prefix}topics AS t ON (t.id_topic = m.id_topic)]]></search>
			<add><![CDATA[
		SELECT COALESCE(chars.character_name, mem.real_name, m.poster_name) AS poster_name, m.poster_time, m.body, m.id_topic, m.subject,
			m.id_board, m.id_member, m.approved
		FROM {db_prefix}messages AS m
			LEFT JOIN {db_prefix}characters AS chars ON (m.id_character = chars.id_character)
			INNER JOIN {db_prefix}topics AS t ON (t.id_topic = m.id_topic)]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
				SELECT m.subject, COALESCE(mem.real_name, m.poster_name) AS poster_name, m.poster_time, m.body
				FROM {db_prefix}messages AS m
					INNER JOIN {db_prefix}boards AS b ON (b.id_board = m.id_board AND {query_see_board})]]></search>
			<add><![CDATA[
				SELECT m.subject, COALESCE(chars.character_name, mem.real_name, m.poster_name) AS poster_name, m.poster_time, m.body
				FROM {db_prefix}messages AS m
					LEFT JOIN {db_prefix}characters AS chars ON (m.id_character = chars.id_character)
					INNER JOIN {db_prefix}boards AS b ON (b.id_board = m.id_board AND {query_see_board})]]></add>
		</operation>
	</file>

	<!-- Now fix the board index -->
	<file name="$sourcedir/Subs-BoardIndex.php">
		<operation>
			<search position="replace"><![CDATA[
			m.subject, m.id_topic, COALESCE(mem.real_name, m.poster_name) AS real_name,]]></search>
			<add><![CDATA[
			m.subject, m.id_topic, chars.id_character, COALESCE(chars.character_name, mem.real_name, m.poster_name) AS real_name,]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
			LEFT JOIN {db_prefix}messages AS m ON (m.id_msg = b.id_last_msg)]]></search>
			<add><![CDATA[
			LEFT JOIN {db_prefix}messages AS m ON (m.id_msg = b.id_last_msg)
			LEFT JOIN {db_prefix}characters AS chars ON (m.id_character = chars.id_character)]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
				'href' => $row_board['poster_name'] != '' && !empty($row_board['id_member']) ? $scripturl . '?action=profile;u=' . $row_board['id_member'] : '',
				'link' => $row_board['poster_name'] != '' ? (!empty($row_board['id_member']) ? '<a href="' . $scripturl . '?action=profile;u=' . $row_board['id_member'] . '">' . $row_board['real_name'] . '</a>' : $row_board['real_name']) : $txt['not_applicable'],]]></search>
			<add><![CDATA[
				'href' => $row_board['poster_name'] != '' && !empty($row_board['id_member']) ? $scripturl . '?action=profile;u=' . $row_board['id_member'] . (!empty($row_board['id_character']) ? ';area=characters;char=' . $row_board['id_character'] : ''): '',
				'link' => $row_board['poster_name'] != '' ? (!empty($row_board['id_member']) ? '<a href="' . $scripturl . '?action=profile;u=' . $row_board['id_member'] . (!empty($row_board['id_character']) ? ';area=characters;char=' . $row_board['id_character'] : '') . '">' . $row_board['real_name'] . '</a>' : $row_board['real_name']) : $txt['not_applicable'],]]></add>
		</operation>
	</file>

	<!-- Fix the autosuggester -->
	<file name="$themedir/scripts/PersonalMessage.js">
		<operation>
			<search position="replace"><![CDATA[		sControlId: this.opt.sToControlId,
		sSearchType: 'member',]]></search>
			<add><![CDATA[		sControlId: this.opt.sToControlId,
		sSearchType: 'memberchar',]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[		sControlId: this.opt.sBccControlId,
		sSearchType: 'member',]]></search>
			<add><![CDATA[		sControlId: this.opt.sBccControlId,
		sSearchType: 'memberchar',]]></add>
		</operation>
	</file>

	<!-- Cleaning up the profile area -->
	<file name="$sourcedir/Profile-Modify.php">
		<operation>
			<search position="replace"><![CDATA[
			'avatar_choice', 'hr', 'personal_text', 'hr',
			'bday1', 'usertitle', 'signature', 'hr',]]></search>
			<add><![CDATA[
			'personal_text', 'hr', 'bday1', 'usertitle', 'hr',]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA['id_theme', 'smiley_set', 'hr',]]></search>
			<add><![CDATA['smiley_set', 'hr',]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA['email_address', 'show_online', 'hr',
			'tfa', 'hr',]]></search>
			<add><![CDATA['email_address', 'show_online', 'hr',
			'immersive_mode', 'hr',
			'tfa', 'hr',]]></add>
		</operation>
	</file>
	<file name="$sourcedir/Profile-View.php">
		<operation>
			<search position="replace"><![CDATA[$action_text = $row['action'];

		// Parse BBC?]]></search>
			<add><![CDATA[$action_text = $row['action'];

		// Character related edit?
		if (!empty($extra['id_character']))
		{
			if (!empty($context['member']['characters'][$extra['id_character']]))
				$character_name = $context['member']['characters'][$extra['id_character']]['character_name'];
			else
				$character_name = $extra['character_name'];

			$action_text = sprintf($action_text, $character_name);
		}

		// Parse BBC?]]></add>
		</operation>
	</file>

	<!-- Moving that fscking logout button -->
	<file name="$themedir/index.template.php">
		<operation>
			<search position="replace"><![CDATA[
		// And now we're done.
		echo '
		</ul>';]]></search>
			<add><![CDATA[
		// And now we're done.
		echo '
			<li>
				<a href="', $scripturl, '?action=logout;', $context['session_var'], '=', $context['session_id'], '">', $txt['logout'], '</a>
			</li>
		</ul>';]]></add>
		</operation>
	</file>

	<!-- Marking boards as OOC -->
	<file name="$sourcedir/Load.php">
		<operation>
			<search position="replace"><![CDATA[b.child_level,
				b.id_theme, b.override_theme, b.count_posts, b.id_profile, b.redirect,]]></search>
			<add><![CDATA[b.child_level, b.in_character,
				b.id_theme, b.override_theme, b.count_posts, b.id_profile, b.redirect,]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA['recycle' => !empty($modSettings['recycle_enable']) && !empty($modSettings['recycle_board']) && $modSettings['recycle_board'] == $board,
				'posts_count' => empty($row['count_posts']),]]></search>
			<add><![CDATA['recycle' => !empty($modSettings['recycle_enable']) && !empty($modSettings['recycle_board']) && $modSettings['recycle_board'] == $board,
				'in_character' => !empty($row['in_character']),
				'posts_count' => empty($row['count_posts']),]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[// Remove all the permissions they shouldn't have ;).
	if (!empty($modSettings['permission_enable_deny']))
		$user_info['permissions'] = array_diff($user_info['permissions'], $removals);]]></search>
			<add><![CDATA[// Remove all the permissions they shouldn't have ;).
	if (!empty($modSettings['permission_enable_deny']))
		$user_info['permissions'] = array_diff($user_info['permissions'], $removals);

	// And if this is an OOC board, we might have to remove some permissions.
	$disable_posting = !empty($board_info['in_character']) && $user_info['char_is_main'];
	if ($disable_posting)
	{
		$user_info['permissions'] = array_diff($user_info['permissions'], array(
			'moderate_board',
			'approve_posts',
			'post_new',
			'post_unapproved_topics',
			'post_unapproved_replies_own',
			'post_unapproved_replies_any',
			'post_reply_own',
			'post_reply_any',
			'post_draft',
			'post_attachment',
			'modify_own',
			'modify_any',
			'modify_replies',
			'delete_own',
			'delete_any',
			'delete_replies',
			'merge_any',
			'split_any',
			'lock_own',
			'lock_any',
			'remove_own',
			'remove_any',
			'poll_vote',
			'poll_post',
			'poll_add_own',
			'poll_add_any',
			'poll_edit_own',
			'poll_edit_any',
			'poll_lock_own',
			'poll_lock_any',
			'poll_remove_own',
			'poll_remove_any',
			'post_unapproved_attachments',
			'post_attachment',
		));
	}]]></add>
		</operation>
	</file>
	<file name="$sourcedir/Subs-Boards.php">
		<operation>
			<search position="replace"><![CDATA[COALESCE(b.id_board, 0) AS id_board, b.id_parent, b.name AS board_name, b.description, b.child_level,]]></search>
			<add><![CDATA[COALESCE(b.id_board, 0) AS id_board, b.id_parent, b.name AS board_name, b.description, b.child_level, b.in_character,]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA['redirect' => $row['redirect'],
				'prev_board' => $prevBoard]]></search>
			<add><![CDATA['redirect' => $row['redirect'],
				'in_character' => $row['in_character'],
				'prev_board' => $prevBoard]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[if (isset($boardOptions['num_posts']))
	{
		$boardUpdates[] = 'num_posts = {int:num_posts}';
		$boardUpdateParameters['num_posts'] = (int) $boardOptions['num_posts'];
	}

	$id = $board_id;]]></search>
			<add><![CDATA[if (isset($boardOptions['num_posts']))
	{
		$boardUpdates[] = 'num_posts = {int:num_posts}';
		$boardUpdateParameters['num_posts'] = (int) $boardOptions['num_posts'];
	}

	if (isset($boardOptions['in_character']))
	{
		$boardUpdates[] = 'in_character = {int:in_character}';
		$boardUpdateParameters['in_character'] = !empty($boardOptions['in_character']) ? 1 : 0;
	}

	$id = $board_id;]]></add>
		</operation>
	</file>
	<file name="$sourcedir/ManageBoards.php">
		<operation>
			<search position="replace"><![CDATA['override_theme' => 0,
			'redirect' => '',]]></search>
			<add><![CDATA['override_theme' => 0,
			'in_character' => 1,
			'redirect' => '',]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[// Checkboxes....
		$boardOptions['posts_count'] = isset($_POST['count']);]]></search>
			<add><![CDATA[// Checkboxes....
		$boardOptions['in_character'] = !empty($_POST['in_character']);
		$boardOptions['posts_count'] = isset($_POST['count']);]]></add>
		</operation>
	</file>
	<file name="$themedir/ManageBoards.template.php">
		<operation>
			<search position="replace"><![CDATA[</dd>
					<dt>
						<strong>', $txt['permission_profile'], ':</strong><br>]]></search>
			<add><![CDATA[</dd>
					<dt>
						<strong>', $txt['board_in_character'], '</strong><br>
						<span class="smalltext">', $txt['board_in_character_desc'], '</span><br>
					</dt>
					<dd>
						<input type="checkbox" name="in_character"', $context['board']['in_character'] ? ' checked' : '', ' class="input_check">
					</dd>
					<dt>
						<strong>', $txt['permission_profile'], ':</strong><br>]]></add>
		</operation>
	</file>

	<!-- We also need to fix up searching. -->
	<file name="$sourcedir/Search.php">
		<operation>
			<search position="replace"><![CDATA[
				first_mem.id_member AS first_member_id, COALESCE(first_mem.real_name, first_m.poster_name) AS first_member_name,
				last_m.id_msg AS last_msg, last_m.poster_time AS last_poster_time, last_mem.id_member AS last_member_id,
				COALESCE(last_mem.real_name, last_m.poster_name) AS last_member_name, last_m.icon AS last_icon, last_m.subject AS last_subject,]]></search>
			<add><![CDATA[
				first_mem.id_member AS first_member_id, m.id_character, COALESCE(char_f.character_name, first_mem.real_name, first_m.poster_name) AS first_member_name,
				last_m.id_msg AS last_msg, last_m.poster_time AS last_poster_time, last_mem.id_member AS last_member_id,
				COALESCE(char_l.character_name, last_mem.real_name, last_m.poster_name) AS last_member_name, last_m.icon AS last_icon, last_m.subject AS last_subject,]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
				INNER JOIN {db_prefix}messages AS first_m ON (first_m.id_msg = t.id_first_msg)
				INNER JOIN {db_prefix}messages AS last_m ON (last_m.id_msg = t.id_last_msg)]]></search>
			<add><![CDATA[
				INNER JOIN {db_prefix}messages AS first_m ON (first_m.id_msg = t.id_first_msg)
				INNER JOIN {db_prefix}messages AS last_m ON (last_m.id_msg = t.id_last_msg)
				LEFT JOIN {db_prefix}characters AS char_f ON (first_m.id_character = char_f.id_character)
				LEFT JOIN {db_prefix}characters AS char_l ON (last_m.id_character = char_l.id_character)]]></add>
		</operation>
	</file>

	<!-- Allow switching between characters on a post -->
	<file name="$themedir/Display.template.php">
		<operation>
			<search position="replace"><![CDATA[// What about splitting it off the rest of the topic?]]></search>
			<add><![CDATA[// What about if we want to post to multiple characters?
		if ($message['can_switch_char'])
		{
			echo '
											<li>
												<a href="#" onclick="return false">
													<span class="generic_icons people"></span> ', $txt['switch_to_char_menu'], '
												</a>
												<ul>';
			foreach ($message['possible_characters'] as $char_id => $char_name) {
				echo '
													<li><a href=" ', $scripturl, '?action=reattributepost;topic=', $context['current_topic'], ';msg=', $message['id'], ';char=', $char_id, ';', $context['session_var'], '=', $context['session_id'], '">', $char_name, '</a></li>';
			}
			echo '
												</ul>
											</li>';
		}

		// What about splitting it off the rest of the topic?]]></add>
		</operation>
	</file>

	<!-- Now to collect registration details -->
	<file name="$themedir/Register.template.php">
		<operation>
			<search position="replace"><![CDATA[							<input type="text" name="email" id="smf_autov_reserve1" size="30" tabindex="', $context['tabindex']++, '" value="', isset($context['email']) ? $context['email'] : '', '" class="input_text">
						</dd>
					</dl>
					<dl class="register_form" id="password1_group">]]></search>
			<add><![CDATA[							<input type="text" name="email" id="smf_autov_reserve1" size="30" tabindex="', $context['tabindex']++, '" value="', isset($context['email']) ? $context['email'] : '', '" class="input_text">
						</dd>
						<dt><strong><label for="real_name_box">', $txt['char_register_nickname'], ':</label></strong></dt>
						<dd>
							<input type="text" id="real_name_box" name="real_name" size="30" tabindex="', $context['tabindex']++, '" maxlength="200" value="', isset($context['real_name']) ? $context['real_name'] : '', '" class="input_text">
						</dd>
						<dt><strong><label for="first_char_box">', $txt['char_register_charname'], ':</label></strong></dt>
						<dd>
							<input type="text" id="first_char_box" name="first_char" size="30" tabindex="', $context['tabindex']++, '" maxlength="200" value="', isset($context['first_char']) ? $context['first_char'] : '', '" class="input_text">
						</dd>
					</dl>
					<dl class="register_form" id="password1_group">]]></add>
		</operation>
	</file>
	<file name="$sourcedir/Register.php">
		<operation>
			<search position="replace"><![CDATA[	$possible_strings = array(
		'birthdate',]]></search>
			<add><![CDATA[	$possible_strings = array(
		'first_char',
		'birthdate',]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[	$context += array(
		'username' => isset($_POST['user']) ? $smcFunc['htmlspecialchars']($_POST['user']) : '',
		'email' => isset($_POST['email']) ? $smcFunc['htmlspecialchars']($_POST['email']) : '',
		'notify_announcements' => !empty($_POST['notify_announcements']) ? 1 : 0,
	);]]></search>
			<add><![CDATA[	$context += array(
		'username' => isset($_POST['user']) ? $smcFunc['htmlspecialchars']($_POST['user']) : '',
		'real_name' => isset($_POST['real_name']) ? $smcFunc['htmlspecialchars']($_POST['real_name']) : '',
		'first_char' => isset($_POST['first_char']) ? $smcFunc['htmlspecialchars']($_POST['first_char']) : '',
		'email' => isset($_POST['email']) ? $smcFunc['htmlspecialchars']($_POST['email']) : '',
		'notify_announcements' => !empty($_POST['notify_announcements']) ? 1 : 0,
	);]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[	// Validation... even if we're not a mall.
	if (isset($_POST['real_name']) && (allowedTo('profile_displayed_name') || allowedTo('moderate_forum')))]]></search>
			<add><![CDATA[	// Validation... even if we're not a mall.
	if (isset($_POST['real_name']))]]></add>
		</operation>
	</file>

	<!-- And fix the maintenance system -->
	<file name="$sourcedir/ManageMaintenance.php">
		<operation>
			<search position="replace"><![CDATA[	// Continue?
	if ($total_rows == $increment)]]></search>
			<add><![CDATA[	// Now to fix the post counts for characters.
	$request = $smcFunc['db_query']('', '
		SELECT /*!40001 SQL_NO_CACHE */ m.id_character, COUNT(m.id_character) AS posts
		FROM ({db_prefix}messages AS m, {db_prefix}boards AS b)
		WHERE m.id_character != {int:zero}
			AND b.count_posts = {int:zero}
			AND m.id_board = b.id_board ' . (!empty($modSettings['recycle_enable']) ? '
			AND b.id_board != {int:recycle}' : '') . '
		GROUP BY m.id_character
		LIMIT {int:start}, {int:number}',
		array(
			'start' => $_REQUEST['start'],
			'number' => $increment,
			'recycle' => $modSettings['recycle_board'],
			'zero' => 0,
		)
	);
	$total_rows = $smcFunc['db_num_rows']($request);

	// Update the post count for this group
	while ($row = $smcFunc['db_fetch_assoc']($request))
	{
		$smcFunc['db_query']('', '
			UPDATE {db_prefix}characters
			SET posts = {int:posts}
			WHERE id_character = {int:row}',
			array(
				'row' => $row['id_character'],
				'posts' => $row['posts'],
			)
		);
	}
	$smcFunc['db_free_result']($request);

	// Continue?
	if ($total_rows == $increment)]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[	// all done]]></search>
			<add><![CDATA[	// now to redo the deliquents on the post count front for characters
	$createTemporaryChar = $smcFunc['db_query']('', '
		CREATE TEMPORARY TABLE {db_prefix}tmp_maint_recountcharposts (
			id_character int(10) unsigned NOT NULL default {string:string_zero},
			PRIMARY KEY (id_member)
		)
		SELECT m.id_character
		FROM ({db_prefix}messages AS m,{db_prefix}boards AS b)
		WHERE m.id_character != {int:zero}
			AND b.count_posts = {int:zero}
			AND m.id_board = b.id_board ' . (!empty($modSettings['recycle_enable']) ? '
			AND b.id_board != {int:recycle}' : '') . '
		GROUP BY m.id_character',
		array(
			'zero' => 0,
			'string_zero' => '0',
			'db_error_skip' => true,
			'recycle' => !empty($modSettings['recycle_board']) ? $modSettings['recycle_board'] : 0,
		)
	) !== false;

	if ($createTemporaryChar)
	{
		// outer join the characters table on the temporary table finding the members that have a post count but no posts in the message table
		$request = $smcFunc['db_query']('', '
			SELECT chars.id_character, chars.posts
			FROM {db_prefix}characters AS chars
			LEFT OUTER JOIN {db_prefix}tmp_maint_recountcharposts AS res
			ON res.id_character = chars.id_character
			WHERE res.id_character IS null
				AND chars.posts != {int:zero}',
			array(
				'zero' => 0,
			)
		);

		// set the post count to zero for any delinquents we may have found
		while ($row = $smcFunc['db_fetch_assoc']($request))
		{
			$smcFunc['db_query']('', '
				UPDATE {db_prefix}characters
				SET posts = {int:zero}
				WHERE id_character = {int:row}',
				array(
					'row' => $row['id_character'],
					'zero' => 0,
				)
			);
		}
		$smcFunc['db_free_result']($request);
	}

	// all done]]></add>
		</operation>
	</file>

	<!-- Character-level membergroups are... interesting. -->
	<file name="$sourcedir/Subs-Membergroups.php">
		<operation>
			<search position="replace"><![CDATA[mg.icons, COALESCE(gm.id_member, 0) AS can_moderate, 0 AS num_members]]></search>
			<add><![CDATA[mg.icons, COALESCE(gm.id_member, 0) AS can_moderate, 0 AS num_members, is_character]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[			'id_group' => $row['id_group'],
			'group_name' => $row['group_name'],]]></search>
			<add><![CDATA[			'id_group' => $row['id_group'],
			'is_character' => $row['is_character'],
			'group_name' => $row['group_name'],]]></add>
		</operation>
	</file>
	<file name="$sourcedir/ManageMembergroups.php">
		<operation>
			<search position="replace"><![CDATA[				'sort' => array(
					'default' => 'CASE WHEN mg.id_group < 4 THEN mg.id_group ELSE 4 END, mg.group_name',
					'reverse' => 'CASE WHEN mg.id_group < 4 THEN mg.id_group ELSE 4 END, mg.group_name DESC',
				),
			),
			'icons' => array(]]></search>
			<add><![CDATA[				'sort' => array(
					'default' => 'CASE WHEN mg.id_group < 4 THEN mg.id_group ELSE 4 END, mg.group_name',
					'reverse' => 'CASE WHEN mg.id_group < 4 THEN mg.id_group ELSE 4 END, mg.group_name DESC',
				),
			),
			'level' => array(
				'header' => array(
					'value' => $txt['char_group_level'],
				),
				'data' => array(
					'function' => function($rowData) use ($txt)
					{
						return empty($rowData['is_character']) ? $txt['char_group_level_acct'] : $txt['char_group_level_char'];
					},
				),
			),
			'icons' => array(]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[			array(
				'id_group' => 'int', 'description' => 'string', 'group_name' => 'string-80', 'min_posts' => 'int',
				'icons' => 'string', 'online_color' => 'string', 'group_type' => 'int',
			),
			array(
				$id_group, '', $smcFunc['htmlspecialchars']($_POST['group_name'], ENT_QUOTES), ($postCountBasedGroup ? (int) $_POST['min_posts'] : '-1'),
				'1#icon.png', '', $_POST['group_type'],
			),]]></search>
			<add><![CDATA[			array(
				'id_group' => 'int', 'description' => 'string', 'group_name' => 'string-80', 'min_posts' => 'int',
				'icons' => 'string', 'online_color' => 'string', 'group_type' => 'int', 'is_character' => 'int',
			),
			array(
				$id_group, '', $smcFunc['htmlspecialchars']($_POST['group_name'], ENT_QUOTES), ($postCountBasedGroup ? (int) $_POST['min_posts'] : '-1'),
				'1#icon.png', '', $_POST['group_type'], !empty($_POST['group_level']) ? 1 : 0,
			),]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[	$request = $smcFunc['db_query']('', '
		SELECT group_name, description, min_posts, online_color, max_messages, icons, group_type, hidden, id_parent, tfa_required]]></search>
			<add><![CDATA[	$request = $smcFunc['db_query']('', '
		SELECT group_name, is_character, description, min_posts, online_color, max_messages, icons, group_type, hidden, id_parent, tfa_required]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[	$context['group'] = array(
		'id' => $_REQUEST['group'],
		'name' => $row['group_name'],
		'description']]></search>
			<add><![CDATA[	$context['group'] = array(
		'id' => $_REQUEST['group'],
		'name' => $row['group_name'],
		'is_character' => $row['is_character'],
		'description']]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA['members' => array('MembergroupMembers', 'manage_membergroups', 'Groups.php'),
		'settings' => array('ModifyMembergroupsettings', 'admin_forum'),]]></search>
			<add><![CDATA['members' => array('MembergroupMembers', 'manage_membergroups', 'Groups.php'),
		'badges' => array('MembergroupBadges', 'admin_forum'),
		'settings' => array('ModifyMembergroupsettings', 'admin_forum'),]]></add>
		</operation>
	</file>
	<file name="$themedir/ManageMembergroups.template.php">
		<operation>
			<search position="replace"><![CDATA[					<dd>
						<input type="text" name="group_name" id="group_name_input" size="30" class="input_text">
					</dd>';
	if ($context['undefined_group'])]]></search>
			<add><![CDATA[					<dd>
						<input type="text" name="group_name" id="group_name_input" size="30" class="input_text">
					</dd>';

	if (!$context['post_group'])
	{
		echo '
					<dt>
						<label for="group_level_input"><strong>', $txt['char_group_level'], ':</strong></label>
					</dt>
					<dd>
						<select name="group_level" id="group_level_input">
							<option value="0">', $txt['char_group_level_acct'], '</option>
							<option value="1">', $txt['char_group_level_char'], '</option>
						</select>
					</dd>';
	}
	if ($context['undefined_group'])]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[					<dd>
						<input type="text" name="group_name" id="group_name_input" value="', $context['group']['editable_name'], '" size="30" class="input_text">
					</dd>';

	if ($context['group']['id'] != 3 && $context['group']['id'] != 4)]]></search>
			<add><![CDATA[					<dd>
						<input type="text" name="group_name" id="group_name_input" value="', $context['group']['editable_name'], '" size="30" class="input_text">
					</dd>';

	if (!$context['group']['is_post_group'])
	{
		echo '
					<dt><strong>', $txt['char_group_level'], ':</strong></dt>
					<dd>', !empty($context['group']['is_character']) ? $txt['char_group_level_char'] : $txt['char_group_level_acct'], '</dd>';
	}

	if ($context['group']['id'] != 3 && $context['group']['id'] != 4)]]></add>
		</operation>
	</file>
	<file name="$sourcedir/Profile-Modify.php">
		<operation>
			<search position="replace"><![CDATA[AND min_posts = {int:min_posts}' . (allowedTo('admin_forum') ? '' : ']]></search>
			<add><![CDATA[AND min_posts = {int:min_posts}
			AND is_character = 0' . (allowedTo('admin_forum') ? '' : ']]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[	// The account page allows the change of your id_group - but not to a protected group!]]></search>
			<add><![CDATA[	// We can't have users adding anyone to character groups
	$char_groups = [];
	$request = $smcFunc['db_query']('', '
		SELECT id_group
		FROM {db_prefix}membergroups
		WHERE is_character = 1');
	while ($row = $smcFunc['db_fetch_row']($request))
		$char_groups[] = $row[0];
	$smcFunc['db_free_result']($request);

	// No primary character group for you!
	if (in_array($value, $char_groups))
		$value = $old_profile['id_group'];

	// No secondary character groups for you!
	if (isset($_POST['additional_groups']) && is_array($_POST['additional_groups']))
		$_POST['additional_groups'] = array_diff($_POST['additional_groups'], $char_groups);

	// The account page allows the change of your id_group - but not to a protected group!]]></add>
		</operation>
	</file>
	<file name="$sourcedir/Groups.php">
		<operation>
			<search position="replace"><![CDATA[SELECT id_group AS id, group_name AS name, CASE WHEN min_posts = {int:min_posts} THEN 1 ELSE 0 END AS assignable, hidden, online_color,
			icons, description, CASE WHEN min_posts != {int:min_posts} THEN 1 ELSE 0 END AS is_post_group, group_type]]></search>
			<add><![CDATA[SELECT id_group AS id, group_name AS name, CASE WHEN min_posts = {int:min_posts} THEN 1 ELSE 0 END AS assignable, hidden, online_color,
			is_character, icons, description, CASE WHEN min_posts != {int:min_posts} THEN 1 ELSE 0 END AS is_post_group, group_type]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[	// The where on the query is interesting. Non-moderators should only see people who are in this group as primary.
	if ($context['group']['can_moderate'])
		$where = $context['group']['is_post_group'] ? 'id_post_group = {int:group}' : 'id_group = {int:group} OR FIND_IN_SET({int:group}, additional_groups) != 0';
	else
		$where = $context['group']['is_post_group'] ? 'id_post_group = {int:group}' : 'id_group = {int:group}';]]></search>
			<add><![CDATA[	// Depending on whether this group is a character group or not...
	// we might have different queries...
	if ($context['group']['is_character'])
	{
		// The where on the query is interesting. Non-moderators should only see people who are in this group as primary.
		if ($context['group']['can_moderate'])
			$where = 'main_char_group = {int:group} OR FIND_IN_SET({int:group}, char_groups) != 0';
		else
			$where = 'main_char_group = {int:group}';
	}
	else
	{
		// The where on the query is interesting. Non-moderators should only see people who are in this group as primary.
		if ($context['group']['can_moderate'])
			$where = $context['group']['is_post_group'] ? 'id_post_group = {int:group}' : 'id_group = {int:group} OR FIND_IN_SET({int:group}, additional_groups) != 0';
		else
			$where = $context['group']['is_post_group'] ? 'id_post_group = {int:group}' : 'id_group = {int:group}';
	}]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[SELECT COUNT(*)
		FROM {db_prefix}members]]></search>
			<add><![CDATA[SELECT COUNT(*)
		FROM ' . ($context['group']['is_character'] ? '{db_prefix}characters' : '{db_prefix}members') . ']]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[	// Load up all members of this group.
	$request = $smcFunc['db_query']('', '
		SELECT id_member, member_name, real_name, email_address, member_ip, date_registered, last_login,
			posts, is_activated, real_name
		FROM {db_prefix}members
		WHERE ' . $where . '
		ORDER BY ' . $querySort . ' ' . ($context['sort_direction'] == 'down' ? 'DESC' : 'ASC') . '
		LIMIT ' . $context['start'] . ', ' . $modSettings['defaultMaxMembers'],
		array(
			'group' => $_REQUEST['group'],
		)
	);]]></search>
			<add><![CDATA[	// Load up all members of this group.
	if ($context['group']['is_character'])
	{
		$request = $smcFunc['db_query']('', '
			SELECT mem.id_member, member_name, real_name, email_address, member_ip, date_registered, last_login,
				chars.posts, is_activated, real_name, id_character, character_name
			FROM {db_prefix}members AS mem
				INNER JOIN {db_prefix}characters AS chars ON (chars.id_member = mem.id_member)
			WHERE ' . $where . '
			ORDER BY ' . $querySort . ' ' . ($context['sort_direction'] == 'down' ? 'DESC' : 'ASC') . '
			LIMIT ' . $context['start'] . ', ' . $modSettings['defaultMaxMembers'],
			array(
				'group' => $_REQUEST['group'],
			)
		);
	} else {
		$request = $smcFunc['db_query']('', '
			SELECT id_member, member_name, real_name, email_address, member_ip, date_registered, last_login,
				posts, is_activated, real_name
			FROM {db_prefix}members
			WHERE ' . $where . '
			ORDER BY ' . $querySort . ' ' . ($context['sort_direction'] == 'down' ? 'DESC' : 'ASC') . '
			LIMIT ' . $context['start'] . ', ' . $modSettings['defaultMaxMembers'],
			array(
				'group' => $_REQUEST['group'],
			)
		);
	}
	]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[		$context['members'][] = array(
			'id' => $row['id_member'],
			'name' => '<a href="' . $scripturl . '?action=profile;u=' . $row['id_member'] . '">' . $row['real_name'] . '</a>',
			'email' => $row['email_address'],]]></search>
			<add><![CDATA[		$context['members'][] = array(
			'id' => $row['id_member'],
			'name' => '<a href="' . $scripturl . '?action=profile;u=' . $row['id_member'] . '">' . $row['real_name'] . '</a>',
			'id_character' => !empty($row['id_character']) ? $row['id_character'] : 0,
			'character' => !empty($row['id_character']) ? '<a href="' . $scripturl . '?action=profile;u=' . $row['id_member'] . ';area=characters;char=' . $row['id_character'] . '">' . $row['character_name'] . '</a>' : '',
			'email' => $row['email_address'],]]></add>
		</operation>
	</file>
	<file name="$themedir/ManageMembergroups.template.php">
		<operation>
			<search position="replace"><![CDATA[						<th><a href="', $scripturl, '?action=', $context['current_action'], (isset($context['admin_area']) ? ';area=' . $context['admin_area'] : ''), ';sa=members;start=', $context['start'], ';sort=name', $context['sort_by'] == 'name' && $context['sort_direction'] == 'up' ? ';desc' : '', ';group=', $context['group']['id'], '">', $txt['name'], $context['sort_by'] == 'name' ? ' <span class="generic_icons sort_' . $context['sort_direction'] . '"></span>' : '', '</a></th>';

	if ($context['can_send_email'])]]></search>
			<add><![CDATA[						<th><a href="', $scripturl, '?action=', $context['current_action'], (isset($context['admin_area']) ? ';area=' . $context['admin_area'] : ''), ';sa=members;start=', $context['start'], ';sort=name', $context['sort_by'] == 'name' && $context['sort_direction'] == 'up' ? ';desc' : '', ';group=', $context['group']['id'], '">', $txt['name'], $context['sort_by'] == 'name' ? ' <span class="generic_icons sort_' . $context['sort_direction'] . '"></span>' : '', '</a></th>';

	if ($context['group']['is_character'])
		echo '
						<th>', rtrim($txt['char_name'], ':'), '</th>';

	if ($context['can_send_email'])]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[<td>', $member['name'], '</td>';
		if ($context['can_send_email'])]]></search>
			<add><![CDATA[<td>', $member['name'], '</td>';
		if (!empty($member['character']))
			echo '
						<td>
							', $member['character'], '
						</td>';

		if ($context['can_send_email'])]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[		if (!empty($context['group']['assignable']))
			echo '
						<td style="width: 4%"><input type="checkbox" name="rem[]" value="', $member['id'], '" class="input_check" ', ($context['user']['id'] == $member['id'] && $context['group']['id'] == 1 ? 'onclick="if (this.checked) return confirm(\'' . $txt['membergroups_members_deadmin_confirm'] . '\')" ' : ''), '/></td>';]]></search>
			<add><![CDATA[		if (!empty($context['group']['assignable']))
		{
			if ($context['group']['is_character'])
				echo '
						<td style="width: 4%"><input type="checkbox" name="rem[]" value="', $member['id_character'], '" class="input_check" /></td>';
			else
				echo '
						<td style="width: 4%"><input type="checkbox" name="rem[]" value="', $member['id'], '" class="input_check" ', ($context['user']['id'] == $member['id'] && $context['group']['id'] == 1 ? 'onclick="if (this.checked) return confirm(\'' . $txt['membergroups_members_deadmin_confirm'] . '\')" ' : ''), '/></td>';
		}]]></add>
		</operation>
	</file>
	<file name="$sourcedir/Subs-Membergroups.php">
		<operation>
			<search position="replace"><![CDATA[			// Only do additional groups if we can moderate...]]></search>
			<add><![CDATA[			// And collect all the characters too.
			$query = $smcFunc['db_query']('', '
				SELECT main_char_group, COUNT(*) AS num_members
				FROM {db_prefix}characters
				WHERE main_char_group IN ({array_int:group_list})
				GROUP BY main_char_group',
				array(
					'group_list' => $group_ids,
				)
			);
			while ($row = $smcFunc['db_fetch_assoc']($query))
				$groups[$row['main_char_group']]['num_members'] += $row['num_members'];
			$smcFunc['db_free_result']($query);

			if ($context['can_moderate'])
			{
				$query = $smcFunc['db_query']('', '
					SELECT mg.id_group, COUNT(*) AS num_members
					FROM {db_prefix}membergroups AS mg
						INNER JOIN {db_prefix}characters AS chars ON (chars.char_groups != {string:blank_string}
							AND chars.main_char_group != mg.id_group
							AND FIND_IN_SET(mg.id_group, chars.char_groups) != 0)
					WHERE mg.id_group IN ({array_int:group_list})
					GROUP BY mg.id_group',
					array(
						'group_list' => $group_ids,
						'blank_string' => '',
					)
				);
				while ($row = $smcFunc['db_fetch_assoc']($query))
					$groups[$row['id_group']]['num_members'] += $row['num_members'];
				$smcFunc['db_free_result']($query);
			}

			// Only do additional groups if we can moderate...]]></add>
		</operation>
	</file>
	<file name="$themedir/ManageMembergroups.template.php">
		<operation>
			<search position="replace"><![CDATA[if (!empty($context['group']['assignable']))
		echo '
		<script>
			var oAddMemberSuggest = new smc_AutoSuggest({
				sSelf: \'oAddMemberSuggest\',
				sSessionId: \'', $context['session_id'], '\',
				sSessionVar: \'', $context['session_var'], '\',
				sSuggestId: \'to_suggest\',
				sControlId: \'toAdd\',
				sSearchType: \'member\',
				sPostName: \'member_add\',
				sURLMask: \'action=profile;u=%item_id%\',
				sTextDeleteItem: \'', $txt['autosuggest_delete_item'], '\',
				bItemList: true,
				sItemListContainerId: \'toAddItemContainer\'
			});
		</script>';]]></search>
			<add><![CDATA[if (!empty($context['group']['assignable']))
		echo '
		<script>
			var oAddMemberSuggest = new smc_AutoSuggest({
				sSelf: \'oAddMemberSuggest\',
				sSessionId: \'', $context['session_id'], '\',
				sSessionVar: \'', $context['session_var'], '\',
				sSuggestId: \'to_suggest\',
				sControlId: \'toAdd\',
				sItemTemplate: \'<input type="hidden" name="%post_name%[]" value="%item_id%"><a href="%item_href%" class="extern" onclick="window.open(this.href, \\\'_blank\\\'); return false;">%item_name%</a>&nbsp;<span class="generic_icons delete" title="%delete_text%" onclick="return %self%.deleteAddedItem(\\\'%item_id%\\\');"></span>\',
				sSearchType: \'' . ($context['group']['is_character'] ? 'character' : 'member') . '\',
				sPostName: \'member_add\',
				sURLMask: \'action=profile;u=%item_id%\',
				sTextDeleteItem: \'', $txt['autosuggest_delete_item'], '\',
				bItemList: true,
				sItemListContainerId: \'toAddItemContainer\'
			});
		</script>';]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[<tr class="windowbg">
						<td colspan="6">', $txt['membergroups_members_no_members'], '</td>
					</tr>]]></search>
			<add><![CDATA[<tr class="windowbg">
						<td colspan="', $context['group']['is_character'] ? 7 : 6, '">', $txt['membergroups_members_no_members'], '</td>
					</tr>]]></add>
		</operation>
	</file>
	<file name="$sourcedir/Groups.php">
		<operation>
			<search position="replace"><![CDATA[		// Any passed by ID?]]></search>
			<add><![CDATA[		// If this is a character group we need to intercept it.
		if ($context['group']['is_character'])
		{
			$character_ids = array();
			if (!empty($_REQUEST['member_add']))
			{
				foreach ($_REQUEST['member_add'] as $id)
				{
					$val = explode(';char=', $id);
					if (isset($val[1]) && $val[1] > 1)
						$character_ids[] = (int) $val[1];
				}
				$_REQUEST['member_add'] = array();
			}
			if (!empty($character_ids))
				addCharactersToGroup($character_ids, $_REQUEST['group']);
		}

		// Any passed by ID?]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[		require_once($sourcedir . '/Subs-Membergroups.php');
		removeMembersFromGroups($_REQUEST['rem'], $_REQUEST['group'], true);]]></search>
			<add><![CDATA[		if ($context['group']['is_character'])
		{
			removeCharactersFromGroups($_REQUEST['rem'], $_REQUEST['group']);
		}
		else
		{
			require_once($sourcedir . '/Subs-Membergroups.php');
			removeMembersFromGroups($_REQUEST['rem'], $_REQUEST['group'], true);
		}]]></add>
		</operation>
	</file>

	<!-- And make sure we search on characters rather than members. -->
	<file name="$sourcedir/Search.php">
		<operation>
			<search position="replace"><![CDATA[		// Retrieve a list of possible members.
		$request = $smcFunc['db_query']('', '
			SELECT id_member
			FROM {db_prefix}members
			WHERE {raw:match_possible_users}',
			array(
				'match_possible_users' => 'real_name LIKE ' . implode(' OR real_name LIKE ', $realNameMatches),
			)
		);]]></search>
			<add><![CDATA[		// Retrieve a list of possible members.
		$request = $smcFunc['db_query']('', '
			SELECT id_character
			FROM {db_prefix}characters
			WHERE {raw:match_possible_users}
			GROUP BY id_member',
			array(
				'match_possible_users' => 'character_name LIKE ' . implode(' OR character_name LIKE ', $realNameMatches),
			)
		);]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[				$memberlist[] = $row['id_member'];
			$userQuery = $smcFunc['db_quote'](
				'(m.id_member IN ({array_int:matched_members}) OR (m.id_member = {int:id_member_guest} AND ({raw:match_possible_guest_names})))',
				array(
					'matched_members' => $memberlist,
					'id_member_guest' => 0,
					'match_possible_guest_names' => 'm.poster_name LIKE ' . implode(' OR m.poster_name LIKE ', $realNameMatches),
				)
			);]]></search>
			<add><![CDATA[				$memberlist[] = $row['id_character'];
			$userQuery = $smcFunc['db_quote'](
				'(m.id_character IN ({array_int:matched_members}) OR (m.id_member = {int:id_member_guest} AND ({raw:match_possible_guest_names})))',
				array(
					'matched_members' => $memberlist,
					'id_member_guest' => 0,
					'match_possible_guest_names' => 'm.poster_name LIKE ' . implode(' OR m.poster_name LIKE ', $realNameMatches),
				)
			);]]></add>
		</operation>
	</file>
	<file name="$themedir/Search.template.php">
		<operation>
			<search position="replace"><![CDATA[sSearchType: \'member\',]]></search>
			<add><![CDATA[sSearchType: \'rawcharacter\',]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[$txt['by_user'], ':</label>]]></search>
			<add><![CDATA[$txt['search_by_character'], ':</label>]]></add>
		</operation>
	</file>
</modification>
