<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">
<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
	<id>Arantor:Characters</id>
	<version>1.0</version>

	<!-- Get the current user's character -->
	<file name="$sourcedir/Load.php">
		<!-- Actually get the data -->
		<operation>
			<search position="replace"><![CDATA[
			$request = $smcFunc['db_query']('', '
				SELECT mem.*, IFNULL(a.id_attach, 0) AS id_attach, a.filename, a.attachment_type
				FROM {db_prefix}members AS mem
					LEFT JOIN {db_prefix}attachments AS a ON (a.id_member = {int:id_member})
				WHERE mem.id_member = {int:id_member}
				LIMIT 1',
				array(
					'id_member' => $id_member,
				)
			);]]></search>
			<add><![CDATA[
			$request = $smcFunc['db_query']('', '
				SELECT mem.*, chars.id_character, chars.character_name, chars.avatar AS char_avatar, chars.signature AS char_signature,
					chars.id_theme, IFNULL(a.id_attach, 0) AS id_attach, a.filename, a.attachment_type
				FROM {db_prefix}members AS mem
					LEFT JOIN {db_prefix}attachments AS a ON (a.id_member = {int:id_member})
					LEFT JOIN {db_prefix}characters AS chars ON (chars.id_character = mem.current_character)
				WHERE mem.id_member = {int:id_member}
				LIMIT 1',
				array(
					'id_member' => $id_member,
				)
			);]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
	if (!empty($new_loaded_ids) && $set !== 'minimal')
	{]]></search>
			<add><![CDATA[
	if (!empty($new_loaded_ids) && $set !== 'minimal')
	{
		$request = $smcFunc['db_query']('', '
			SELECT id_member, id_character, character_name, avatar, signature, id_theme, posts, age, date_created, last_active
			FROM {db_prefix}characters
			WHERE id_member IN ({array_int:loaded_ids})
			ORDER BY NULL',
			array(
				'loaded_ids' => $new_loaded_ids,
			)
		);
		while ($row = $smcFunc['db_fetch_assoc']($request))
			$user_profile[$row['id_member']]['characters'][$row['id_character']] = array(
				'id_character' => $row['id_character'],
				'character_name' => $row['character_name'],
				'character_url' => '?action=profile;u=' . $row['id_member'] . ';area=characters;char=' . $row['id_character'],
				'avatar' => $row['avatar'],
				'signature' => $row['signature'],
				'sig_parsed' => !empty($row['signature']) ? parse_bbc($row['signature'], true, 'sig_char_' . $row['id_character']) : '',
				'posts' => $row['posts'],
				'age' => $row['age'],
				'date_created' => $row['date_created'],
				'last_active' => $row['last_active'],
			);
		$smcFunc['db_free_result']($request);

		foreach ($user_profile as $id_member => $member)
		{
			if (!isset($member['characters'])) {
				$user_profile[$id_member]['characters'] = array();
			} else {
				uasort($user_profile[$id_member]['characters'], function ($a, $b) {
					return $a['character_name'] > $b['character_name'] ? 1 : ($a['character_name'] < $a['character_name'] ? -1 : 0);
				});
			}
		}]]></add>
		</operation>
	</file>

	<!-- Make sure we push the current character id into the log when we fill it generally -->
	<file name="$sourcedir/Logging.php">
		<operation>
			<search position="replace"><![CDATA[
		$smcFunc['db_insert']($do_delete ? 'ignore' : 'replace',
			'{db_prefix}log_online',
			array('session' => 'string', 'id_member' => 'int', 'id_spider' => 'int', 'log_time' => 'int', 'ip' => 'raw', 'url' => 'string'),
			array($session_id, $user_info['id'], empty($_SESSION['id_robot']) ? 0 : $_SESSION['id_robot'], time(), 'IFNULL(INET_ATON(\'' . $user_info['ip'] . '\'), 0)', $serialized),
			array('session')
		);]]></search>
			<add><![CDATA[
		$smcFunc['db_insert']($do_delete ? 'ignore' : 'replace',
			'{db_prefix}log_online',
			array('session' => 'string', 'id_member' => 'int', 'id_character' => 'int', 'id_spider' => 'int', 'log_time' => 'int', 'ip' => 'raw', 'url' => 'string'),
			array($session_id, $user_info['id'], $user_info['id_character'], empty($_SESSION['id_robot']) ? 0 : $_SESSION['id_robot'], time(), 'IFNULL(INET_ATON(\'' . $user_info['ip'] . '\'), 0)', $serialized),
			array('session')
		);]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
		$user_settings['total_time_logged_in'] += time() - $_SESSION['timeOnlineUpdated'];]]></search>
			<add><![CDATA[
		$user_settings['total_time_logged_in'] += time() - $_SESSION['timeOnlineUpdated'];
		$smcFunc['db_query']('', '
			UPDATE {db_prefix}characters
			SET last_active = {int:last_active}
			WHERE id_character = {int:character}',
			array(
				'last_active' => time(),
				'character' => $user_info['id_character'],
			)
		);]]></add>
		</operation>
	</file>
	<file name="$sourcedir/Subs-MembersOnline.php">
		<operation>
			<search position="replace"><![CDATA[
	$request = $smcFunc['db_query']('', '
		SELECT
			lo.id_member, lo.log_time, lo.id_spider, mem.real_name, mem.member_name, mem.show_online,
			mg.online_color, mg.id_group, mg.group_name
		FROM {db_prefix}log_online AS lo
			LEFT JOIN {db_prefix}members AS mem ON (mem.id_member = lo.id_member)
			LEFT JOIN {db_prefix}membergroups AS mg ON (mg.id_group = CASE WHEN mem.id_group = {int:reg_mem_group} THEN mem.id_post_group ELSE mem.id_group END)',]]></search>
			<add><![CDATA[
	$request = $smcFunc['db_query']('', '
		SELECT
			lo.id_member, lo.log_time, lo.id_spider, IFNULL(chars.character_name, mem.real_name) AS real_name, mem.member_name, mem.show_online,
			mg.online_color, mg.id_group, mg.group_name
		FROM {db_prefix}log_online AS lo
			LEFT JOIN {db_prefix}members AS mem ON (mem.id_member = lo.id_member)
			LEFT JOIN {db_prefix}membergroups AS mg ON (mg.id_group = CASE WHEN mem.id_group = {int:reg_mem_group} THEN mem.id_post_group ELSE mem.id_group END)
			LEFT JOIN {db_prefix}characters AS chars ON (lo.id_character = chars.id_character)',]]></add>
		</operation>
	</file>

	<!-- The user's menu -->
	<file name="$themedir/index.template.php">
		<operation>
			<search position="replace"><![CDATA[
		// Secondly, PMs if we're doing them]]></search>
			<add><![CDATA[
		echo '
			<li>
				<a href="', $scripturl, '?action=profile;area=characters" id="characters_menu_top" onclick="return false;">
				', sprintf($txt['posting_as'], $GLOBALS['user_info']['character_name']), ' &#9660;</a>
				<div id="characters_menu" class="top_menu"></div>
			</li>';

		// Secondlyish, PMs if we're doing them]]></add>
		</operation>
	</file>

	<!-- Adding character details to saving -->
	<file name="$sourcedir/Post.php">
		<operation>
			<search position="replace"><![CDATA[
	$posterOptions = array(
		'id' => $user_info['id'],]]></search>
			<add><![CDATA[
	$posterOptions = array(
		'id' => $user_info['id'],
		'char_id' => $user_info['id_character'],]]></add>
		</operation>
	</file>

	<!-- Now display the character poster -->
	<file name="$themedir/Display.template.php">
		<operation>
			<search position="replace"><![CDATA[
	echo '
								', $message['member']['link'], ']]></search>
			<add><![CDATA[
	if (isset($message['member']['characters'][$message['id_character']]))
	{
		$character = $message['member']['characters'][$message['id_character']];
		$profile_link = '<a href="' . $scripturl . $character['character_url'] . '">' . $character['character_name'] . '</a>';
	}
	else
	{
		$profile_link = $message['member']['link'];
	}
	echo '
								', $profile_link, ']]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
	// Show the user's avatar.
	if (!empty($modSettings['show_user_images']) && empty($options['show_no_avatars']) && !empty($message['member']['avatar']['image']))
		echo '
								<li class="avatar">
									<a href="', $scripturl, '?action=profile;u=', $message['member']['id'], '">', $message['member']['avatar']['image'], '</a>
								</li>';]]></search>
			<add><![CDATA[
	// Show the user's avatar.
	if (!empty($modSettings['show_user_images']) && empty($options['show_no_avatars']))
	{
		$character = $message['member']['characters'][$message['id_character']];
		if (isset($message['member']['characters'][$message['id_character']]))
		{
			$profile_link = $character['character_url'];
			$profile_avatar = empty($character['avatar']) ? '' : '<img class="avatar" src="' . $character['avatar'] . '" alt="">';
		}
		else
		{
			$profile_link = '?action=profile;u=' . $message['member']['id'];
			$profile_avatar = !empty($message['member']['avatar']['image']) ? $message['member']['avatar']['image'] : '';
		}

		if (!empty($profile_avatar))
		{
			echo '
								<li class="avatar">
									<a href="', $scripturl, $profile_link, '">', $profile_avatar, '</a>
								</li>';
		}
	}]]></add>
		</operation>
	</file>

	<!-- Now fix the board index -->
	<file name="$sourcedir/Subs-BoardIndex.php">
		<operation>
			<search position="replace"><![CDATA[
			m.subject, m.id_topic, IFNULL(mem.real_name, m.poster_name) AS real_name,]]></search>
			<add><![CDATA[
			m.subject, m.id_topic, IFNULL(IFNULL(chars.character_name, mem.real_name), m.poster_name) AS real_name,]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
			LEFT JOIN {db_prefix}messages AS m ON (m.id_msg = b.id_last_msg)]]></search>
			<add><![CDATA[
			LEFT JOIN {db_prefix}messages AS m ON (m.id_msg = b.id_last_msg)
			LEFT JOIN {db_prefix}characters AS chars ON (m.id_character = chars.id_character)]]></add>
		</operation>
	</file>

	<!-- Fix the autosuggester -->
	<file name="$themedir/scripts/PersonalMessage.js">
		<operation>
			<search position="replace"><![CDATA[		sControlId: this.opt.sToControlId,
		sSearchType: 'member',]]></search>
			<add><![CDATA[		sControlId: this.opt.sToControlId,
		sSearchType: 'memberchar',]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[		sControlId: this.opt.sBccControlId,
		sSearchType: 'member',]]></search>
			<add><![CDATA[		sControlId: this.opt.sBccControlId,
		sSearchType: 'memberchar',]]></add>
		</operation>
	</file>

	<!-- Cleaning up the profile area -->
	<file name="$sourcedir/Profile-Modify.php">
		<operation>
			<search position="replace"><![CDATA[
			'avatar_choice', 'hr', 'personal_text', 'hr',
			'bday1', 'usertitle', 'signature', 'hr',]]></search>
			<add><![CDATA[
			'personal_text', 'hr', 'bday1', 'usertitle', 'hr',]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA['id_theme', 'smiley_set', 'hr',]]></search>
			<add><![CDATA['smiley_set', 'hr',]]></add>
		</operation>
	</file>
	<file name="$sourcedir/ManagePermissions.php">
		<operation>
			<search position="replace"><![CDATA[
			'profile_blurb' => array(true, 'profile'),
			'profile_server_avatar' => array(false, 'profile'),
			'profile_upload_avatar' => array(false, 'profile'),
			'profile_remote_avatar' => array(false, 'profile'),]]></search>
			<add><![CDATA[
			'profile_blurb' => array(true, 'profile'),
			// Avatar permissions were here]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
			'profile_signature' => array(true, 'profile'),]]></search>
			<add><![CDATA[
			// Signature permission was here]]></add>
		</operation>
	</file>

	<!-- Moving that fscking logout button -->
	<file name="$themedir/index.template.php">
		<operation>
			<search position="replace"><![CDATA[
		// And now we're done.
		echo '
		</ul>';]]></search>
			<add><![CDATA[
		// And now we're done.
		echo '
			<li>
				<a href="', $scripturl, '?action=logout;', $context['session_var'], '=', $context['session_id'], '">', $txt['logout'], '</a>
			</li>
		</ul>';]]></add>
		</operation>
	</file>
</modification>
