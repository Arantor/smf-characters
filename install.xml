<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">
<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
	<id>Arantor:Characters</id>
	<version>1.0</version>

	<!-- Get the current user's character -->
	<file name="$sourcedir/Load.php">
		<!-- Actually get the data -->
		<operation>
			<search position="replace"><![CDATA[
			$request = $smcFunc['db_query']('', '
				SELECT mem.*, COALESCE(a.id_attach, 0) AS id_attach, a.filename, a.attachment_type
				FROM {db_prefix}members AS mem
					LEFT JOIN {db_prefix}attachments AS a ON (a.id_member = {int:id_member})
				WHERE mem.id_member = {int:id_member}
				LIMIT 1',
				array(
					'id_member' => $id_member,
				)
			);]]></search>
			<add><![CDATA[
			$request = $smcFunc['db_query']('', '
				SELECT mem.*, chars.id_character, chars.character_name, chars.avatar AS char_avatar, chars.signature AS char_signature,
					chars.id_theme, chars.is_main, chars.main_char_group, chars.char_groups, COALESCE(a.id_attach, 0) AS id_attach, a.filename, a.attachment_type
				FROM {db_prefix}members AS mem
					LEFT JOIN {db_prefix}attachments AS a ON (a.id_member = {int:id_member})
					LEFT JOIN {db_prefix}characters AS chars ON (chars.id_character = mem.current_character)
				WHERE mem.id_member = {int:id_member}
				LIMIT 1',
				array(
					'id_member' => $id_member,
				)
			);]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[		// Because history has proven that it is possible for groups to go bad - clean up in case.]]></search>
			<add><![CDATA[		// Now splice in the current character's groups if they have any.
		if (!empty($user_settings['main_char_group']))
			$user_info['groups'][] = $user_settings['main_char_group'];
		if (!empty($user_settings['char_groups']))
			$user_info['groups'] = array_merge($user_info['groups'], explode(',', $user_settings['char_groups']));

		// Because history has proven that it is possible for groups to go bad - clean up in case.]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
	if (!empty($new_loaded_ids) && $set !== 'minimal')
	{]]></search>
			<add><![CDATA[
	if (!empty($new_loaded_ids) && $set !== 'minimal')
	{
		foreach ($new_loaded_ids as $new_id)
		{
			// We might need to juggle the colours around - but only for
			// non main characters. Main will inherit the account so no
			// changes required. This is to fix things like who's online
			// colour; we'll have to fix icon display elsewhere separately.
			if (empty($user_profile[$new_id]['is_main']))
			{
				$user_profile[$new_id]['member_group_color'] = $user_profile[$new_id]['char_group_color'];
				$user_profile[$new_id]['member_group'] = $user_profile[$new_id]['character_group'];
			}
		}
		$request = $smcFunc['db_query']('', '
			SELECT id_member, id_character, character_name, avatar, signature, id_theme, posts, age, date_created,
				last_active, is_main
			FROM {db_prefix}characters
			WHERE id_member IN ({array_int:loaded_ids})
			ORDER BY NULL',
			array(
				'loaded_ids' => $new_loaded_ids,
			)
		);
		while ($row = $smcFunc['db_fetch_assoc']($request))
			$user_profile[$row['id_member']]['characters'][$row['id_character']] = array(
				'id_character' => $row['id_character'],
				'character_name' => $row['character_name'],
				'character_url' => '?action=profile;u=' . $row['id_member'] . ';area=characters;char=' . $row['id_character'],
				'avatar' => $row['avatar'],
				'signature' => $row['signature'],
				'sig_parsed' => !empty($row['signature']) ? parse_bbc($row['signature'], true, 'sig_char_' . $row['id_character']) : '',
				'posts' => $row['posts'],
				'age' => $row['age'],
				'date_created' => $row['date_created'],
				'last_active' => $row['last_active'],
				'is_main' => $row['is_main'],
			);
		$smcFunc['db_free_result']($request);

		foreach ($user_profile as $id_member => $member)
		{
			if (!isset($member['characters'])) {
				$user_profile[$id_member]['characters'] = array();
			} else {
				uasort($user_profile[$id_member]['characters'], function ($a, $b) {
					return $a['character_name'] > $b['character_name'] ? 1 : ($a['character_name'] < $a['character_name'] ? -1 : 0);
				});
			}
		}]]></add>
		</operation>
	</file>

	<!-- Make sure we push the current character id into the log when we fill it generally -->
	<file name="$sourcedir/Logging.php">
		<operation>
			<search position="replace"><![CDATA[
		$smcFunc['db_insert']($do_delete ? 'ignore' : 'replace',
			'{db_prefix}log_online',
			array('session' => 'string', 'id_member' => 'int', 'id_spider' => 'int', 'log_time' => 'int', 'ip' => 'raw', 'url' => 'string'),
			array($session_id, $user_info['id'], empty($_SESSION['id_robot']) ? 0 : $_SESSION['id_robot'], time(), 'COALESCE(INET_ATON(\'' . $user_info['ip'] . '\'), 0)', $serialized),
			array('session')
		);]]></search>
			<add><![CDATA[
		$smcFunc['db_insert']($do_delete ? 'ignore' : 'replace',
			'{db_prefix}log_online',
			array('session' => 'string', 'id_member' => 'int', 'id_character' => 'int', 'id_spider' => 'int', 'log_time' => 'int', 'ip' => 'raw', 'url' => 'string'),
			array($session_id, $user_info['id'], $user_info['id_character'], empty($_SESSION['id_robot']) ? 0 : $_SESSION['id_robot'], time(), 'COALESCE(INET_ATON(\'' . $user_info['ip'] . '\'), 0)', $serialized),
			array('session')
		);]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
		$user_settings['total_time_logged_in'] += time() - $_SESSION['timeOnlineUpdated'];]]></search>
			<add><![CDATA[
		$user_settings['total_time_logged_in'] += time() - $_SESSION['timeOnlineUpdated'];
		$smcFunc['db_query']('', '
			UPDATE {db_prefix}characters
			SET last_active = {int:last_active}
			WHERE id_character = {int:character}',
			array(
				'last_active' => time(),
				'character' => $user_info['id_character'],
			)
		);]]></add>
		</operation>
	</file>
	<file name="$sourcedir/Who.php">
		<operation>
			<search position="replace"><![CDATA[
		SELECT
			lo.log_time, lo.id_member, lo.url, INET_NTOA(lo.ip) AS ip, mem.real_name,
			lo.session, mg.online_color, COALESCE(mem.show_online, 1) AS show_online,
			lo.id_spider
		FROM {db_prefix}log_online AS lo
			LEFT JOIN {db_prefix}members AS mem ON (lo.id_member = mem.id_member)
			LEFT JOIN {db_prefix}membergroups AS mg ON (mg.id_group = CASE WHEN mem.id_group = {int:regular_member} THEN mem.id_post_group ELSE mem.id_group END)' . (!empty($conditions) ? ']]></search>
			<add><![CDATA[
		SELECT
			lo.log_time, lo.id_member, lo.url, INET_NTOA(lo.ip) AS ip, lo.id_character, COALESCE(chars.character_name, mem.real_name) AS real_name,
			lo.session, IF(chars.is_main, mg.online_color, cg.online_color) AS online_color, COALESCE(mem.show_online, 1) AS show_online,
			lo.id_spider
		FROM {db_prefix}log_online AS lo
			LEFT JOIN {db_prefix}members AS mem ON (lo.id_member = mem.id_member)
			LEFT JOIN {db_prefix}membergroups AS mg ON (mg.id_group = CASE WHEN mem.id_group = {int:regular_member} THEN mem.id_post_group ELSE mem.id_group END)
			LEFT JOIN {db_prefix}characters AS chars ON (lo.id_character = chars.id_character)
			LEFT JOIN {db_prefix}membergroups AS cg ON (chars.main_char_group = cg.id_group)' . (!empty($conditions) ? ']]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
		$context['members'][$row['session']] = array(
			'id' => $row['id_member'],]]></search>
			<add><![CDATA[
		$context['members'][$row['session']] = array(
			'id_character' => $row['id_character'],
			'id' => $row['id_member'],]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
			$context['members'][$i] += $memberContext[$member['id']];
	}]]></search>
			<add><![CDATA[
			$context['members'][$i] += $memberContext[$member['id']];

		if (!empty($member['id_character']) && !empty($context['members'][$i]['characters'][$member['id_character']]))
		{
			// Need to 'fix' a few things.
			$character = $context['members'][$i]['characters'][$member['id_character']];
			$context['members'][$i]['name'] = $character['character_name'];
			$context['members'][$i]['href'] .= ';area=characters;char=' . $member['id_character'];
		}
	}]]></add>
		</operation>
	</file>
	<file name="$sourcedir/Subs-MembersOnline.php">
		<operation>
			<search position="replace"><![CDATA[
	$request = $smcFunc['db_query']('', '
		SELECT
			lo.id_member, lo.log_time, lo.id_spider, mem.real_name, mem.member_name, mem.show_online,
			mg.online_color, mg.id_group, mg.group_name
		FROM {db_prefix}log_online AS lo
			LEFT JOIN {db_prefix}members AS mem ON (mem.id_member = lo.id_member)
			LEFT JOIN {db_prefix}membergroups AS mg ON (mg.id_group = CASE WHEN mem.id_group = {int:reg_mem_group} THEN mem.id_post_group ELSE mem.id_group END)',]]></search>
			<add><![CDATA[
	$request = $smcFunc['db_query']('', '
		SELECT
			lo.id_member, lo.log_time, lo.id_spider, chars.id_character, IFNULL(chars.character_name, mem.real_name) AS real_name, mem.member_name, mem.show_online,
			mg.online_color, mg.id_group, mg.group_name
		FROM {db_prefix}log_online AS lo
			LEFT JOIN {db_prefix}members AS mem ON (mem.id_member = lo.id_member)
			LEFT JOIN {db_prefix}membergroups AS mg ON (mg.id_group = CASE WHEN mem.id_group = {int:reg_mem_group} THEN mem.id_post_group ELSE mem.id_group END)
			LEFT JOIN {db_prefix}characters AS chars ON (lo.id_character = chars.id_character)',]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
		// Some basic color coding...
		if (!empty($row['online_color']))
			$link = '<a href="' . $scripturl . '?action=profile;u=' . $row['id_member'] . '" style="color: ' . $row['online_color'] . ';">' . $row['real_name'] . '</a>';
		else
			$link = '<a href="' . $scripturl . '?action=profile;u=' . $row['id_member'] . '">' . $row['real_name'] . '</a>';]]></search>
			<add><![CDATA[
		// Some basic color coding...
		if (!empty($row['online_color']))
			$link = '<a href="' . $scripturl . '?action=profile;u=' . $row['id_member'] . (!empty($row['id_character']) ? ';area=characters;char=' . $row['id_character'] : '') . '" style="color: ' . $row['online_color'] . ';">' . $row['real_name'] . '</a>';
		else
			$link = '<a href="' . $scripturl . '?action=profile;u=' . $row['id_member'] . (!empty($row['id_character']) ? ';area=characters;char=' . $row['id_character'] : '') . '">' . $row['real_name'] . '</a>';]]></add>
		</operation>
	</file>
	<file name="$sourcedir/Display.php">
		<operation>
			<search position="replace"><![CDATA[
			SELECT
				lo.id_member, lo.log_time, mem.real_name, mem.member_name, mem.show_online,
				mg.online_color, mg.id_group, mg.group_name
			FROM {db_prefix}log_online AS lo
				LEFT JOIN {db_prefix}members AS mem ON (mem.id_member = lo.id_member)
				LEFT JOIN {db_prefix}membergroups AS mg ON (mg.id_group = CASE WHEN mem.id_group = {int:reg_id_group} THEN mem.id_post_group ELSE mem.id_group END)]]></search>
			<add><![CDATA[
			SELECT
				lo.id_member, lo.log_time, chars.id_character, IFNULL(chars.character_name, mem.real_name) AS real_name, mem.member_name, mem.show_online,
				mg.online_color, mg.id_group, mg.group_name
			FROM {db_prefix}log_online AS lo
				LEFT JOIN {db_prefix}members AS mem ON (mem.id_member = lo.id_member)
				LEFT JOIN {db_prefix}membergroups AS mg ON (mg.id_group = CASE WHEN mem.id_group = {int:reg_id_group} THEN mem.id_post_group ELSE mem.id_group END)
				LEFT JOIN {db_prefix}characters AS chars ON (lo.id_character = chars.id_character)]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
			if (!empty($row['online_color']))
				$link = '<a href="' . $scripturl . '?action=profile;u=' . $row['id_member'] . '" style="color: ' . $row['online_color'] . ';">' . $row['real_name'] . '</a>';
			else
				$link = '<a href="' . $scripturl . '?action=profile;u=' . $row['id_member'] . '">' . $row['real_name'] . '</a>';]]></search>
			<add><![CDATA[
			if (!empty($row['online_color']))
				$link = '<a href="' . $scripturl . '?action=profile;u=' . $row['id_member'] . (!empty($row['id_character']) ? ';area=characters;char=' . $row['id_character'] : '') . '" style="color: ' . $row['online_color'] . ';">' . $row['real_name'] . '</a>';
			else
				$link = '<a href="' . $scripturl . '?action=profile;u=' . $row['id_member'] . (!empty($row['id_character']) ? ';area=characters;char=' . $row['id_character'] : '') . '">' . $row['real_name'] . '</a>';]]></add>
		</operation>
	</file>
	<file name="$sourcedir/MessageIndex.php">
		<operation>
			<search position="replace"><![CDATA[
			SELECT
				lo.id_member, lo.log_time, mem.real_name, mem.member_name, mem.show_online,
				mg.online_color, mg.id_group, mg.group_name
			FROM {db_prefix}log_online AS lo
				LEFT JOIN {db_prefix}members AS mem ON (mem.id_member = lo.id_member)
				LEFT JOIN {db_prefix}membergroups AS mg ON (mg.id_group = CASE WHEN mem.id_group = {int:reg_member_group} THEN mem.id_post_group ELSE mem.id_group END)]]></search>
			<add><![CDATA[
			SELECT
				lo.id_member, lo.log_time, chars.id_character, IFNULL(chars.character_name, mem.real_name) AS real_name, mem.member_name, mem.show_online,
				mg.online_color, mg.id_group, mg.group_name
			FROM {db_prefix}log_online AS lo
				LEFT JOIN {db_prefix}members AS mem ON (mem.id_member = lo.id_member)
				LEFT JOIN {db_prefix}membergroups AS mg ON (mg.id_group = CASE WHEN mem.id_group = {int:reg_member_group} THEN mem.id_post_group ELSE mem.id_group END)
				LEFT JOIN {db_prefix}characters AS chars ON (lo.id_character = chars.id_character)]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
			if (!empty($row['online_color']))
				$link = '<a href="' . $scripturl . '?action=profile;u=' . $row['id_member'] . '" style="color: ' . $row['online_color'] . ';">' . $row['real_name'] . '</a>';
			else
				$link = '<a href="' . $scripturl . '?action=profile;u=' . $row['id_member'] . '">' . $row['real_name'] . '</a>';]]></search>
			<add><![CDATA[
			if (!empty($row['online_color']))
				$link = '<a href="' . $scripturl . '?action=profile;u=' . $row['id_member'] . (!empty($row['id_character']) ? ';area=characters;char=' . $row['id_character'] : '') . '" style="color: ' . $row['online_color'] . ';">' . $row['real_name'] . '</a>';
			else
				$link = '<a href="' . $scripturl . '?action=profile;u=' . $row['id_member'] . (!empty($row['id_character']) ? ';area=characters;char=' . $row['id_character'] : '') . '">' . $row['real_name'] . '</a>';]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
						'href' => !empty($row['first_id_member']) ? $scripturl . '?action=profile;u=' . $row['first_id_member'] : '',
						'link' => !empty($row['first_id_member']) ? '<a href="' . $scripturl . '?action=profile;u=' . $row['first_id_member'] . '" title="' . $txt['profile_of'] . ' ' . $row['first_display_name'] . '" class="preview">' . $row['first_display_name'] . '</a>' : $row['first_display_name']]]></search>
			<add><![CDATA[
						'href' => !empty($row['first_id_member']) ? $scripturl . '?action=profile;u=' . $row['first_id_member'] : '',
						'link' => !empty($row['first_id_member']) ? '<a href="' . $scripturl . '?action=profile;u=' . $row['first_id_member'] . (!empty($row['first_character']) ? ';area=characters;char=' . $row['first_character'] : '') . '" title="' . $txt['profile_of'] . ' ' . $row['first_display_name'] . '" class="preview">' . $row['first_display_name'] . '</a>' : $row['first_display_name']]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
						'href' => !empty($row['last_id_member']) ? $scripturl . '?action=profile;u=' . $row['last_id_member'] : '',
						'link' => !empty($row['last_id_member']) ? '<a href="' . $scripturl . '?action=profile;u=' . $row['last_id_member'] . '">' . $row['last_display_name'] . '</a>' : $row['last_display_name']]]></search>
			<add><![CDATA[
						'href' => !empty($row['last_id_member']) ? $scripturl . '?action=profile;u=' . $row['last_id_member'] : '',
						'link' => !empty($row['last_id_member']) ? '<a href="' . $scripturl . '?action=profile;u=' . $row['last_id_member'] . (!empty($row['last_character']) ? ';area=characters;char=' . $row['last_character'] : '') . '">' . $row['last_display_name'] . '</a>' : $row['last_display_name']]]></add>
		</operation>
	</file>

	<!-- The user's menu -->
	<file name="$themedir/index.template.php">
		<operation>
			<search position="replace"><![CDATA[
		// Secondly, PMs if we're doing them]]></search>
			<add><![CDATA[
		echo '
			<li>
				<a href="', $scripturl, '?action=profile;area=characters" id="characters_menu_top" onclick="return false;">
				', sprintf($txt['posting_as'], $GLOBALS['user_info']['character_name']), ' &#9660;</a>
				<div id="characters_menu" class="top_menu"></div>
			</li>';

		// Secondlyish, PMs if we're doing them]]></add>
		</operation>
	</file>

	<!-- Adding character details to saving -->
	<file name="$sourcedir/Post.php">
		<operation>
			<search position="replace"><![CDATA[
	$posterOptions = array(
		'id' => $user_info['id'],]]></search>
			<add><![CDATA[
	$posterOptions = array(
		'id' => $user_info['id'],
		'char_id' => $user_info['id_character'],]]></add>
		</operation>
	</file>

	<!-- Fix poster counts when approving posts -->
	<file name="$sourcedir/Subs-Post.php">
		<operation>
			<search position="replace"><![CDATA[topic_approved, b.count_posts]]></search>
			<add><![CDATA[topic_approved, b.count_posts, m.id_character]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
	$member_post_changes = array();]]></search>
			<add><![CDATA[
	$member_post_changes = array();
	$char_post_changes = array();]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
		// Post count for the user?
		if ($row['id_member'] && empty($row['count_posts']))
			$member_post_changes[$row['id_member']] = isset($member_post_changes[$row['id_member']]) ? $member_post_changes[$row['id_member']] + 1 : 1;]]></search>
			<add><![CDATA[
		// Post count for the user?
		if ($row['id_member'] && empty($row['count_posts']))
		{
			$member_post_changes[$row['id_member']] = isset($member_post_changes[$row['id_member']]) ? $member_post_changes[$row['id_member']] + 1 : 1;
			$char_post_changes[$row['id_character']] = isset($char_post_changes[$row['id_character']]) ? $char_post_changes[$row['id_character']] + 1 : 1;
			
		}]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
	// Post count for the members?
	if (!empty($member_post_changes))
		foreach ($member_post_changes as $id_member => $count_change)
			updateMemberData($id_member, array('posts' => 'posts ' . ($approve ? '+' : '-') . ' ' . $count_change));]]></search>
			<add><![CDATA[
	// Post count for the members?
	if (!empty($member_post_changes))
		foreach ($member_post_changes as $id_member => $count_change)
			updateMemberData($id_member, array('posts' => 'posts ' . ($approve ? '+' : '-') . ' ' . $count_change));
	if (!empty($char_post_changes))
		foreach ($char_post_changes as $id_char => $count_change)
			updateCharacterData($id_char, array('posts' => 'posts ' . ($approve ? '+' : '-') . ' ' . $count_change));]]></add>
		</operation>
	</file>

	<!-- Now display the character poster -->
	<file name="$themedir/Display.template.php">
		<operation>
			<search position="replace"><![CDATA[
	// Show the user's avatar.
	if (!empty($modSettings['show_user_images']) && empty($options['show_no_avatars']) && !empty($message['member']['avatar']['image']))
		echo '
								<li class="avatar">
									<a href="', $scripturl, '?action=profile;u=', $message['member']['id'], '">', $message['member']['avatar']['image'], '</a>
								</li>';]]></search>
			<add><![CDATA[
	// Show the user's avatar.
	if (!empty($modSettings['show_user_images']) && empty($options['show_no_avatars']))
	{
		if (isset($message['member']['characters'][$message['id_character']]))
		{
			$character = $message['member']['characters'][$message['id_character']];
			$profile_link = $character['character_url'];
		}
		else
			$profile_link = '?action=profile;u=' . $message['member']['id'];

		if (!empty($message['member']['avatar']['image']))
		{
			echo '
								<li class="avatar">
									<a href="', $scripturl, $profile_link, '">', $message['member']['avatar']['image'], '</a>
								</li>';
		}
	}]]></add>
		</operation>
	</file>
	<file name="$sourcedir/Post.php">
		<operation>
			<search position="replace"><![CDATA[
		SELECT
			COALESCE(mem.real_name, m.poster_name) AS poster_name, m.poster_time,
			m.body, m.smileys_enabled, m.id_msg, m.id_member
		FROM {db_prefix}messages AS m
			LEFT JOIN {db_prefix}members AS mem ON (mem.id_member = m.id_member)]]></search>
			<add><![CDATA[
		SELECT
			COALESCE(chars.character_name, mem.real_name, m.poster_name) AS poster_name, m.poster_time,
			m.body, m.smileys_enabled, m.id_msg, m.id_member
		FROM {db_prefix}messages AS m
			LEFT JOIN {db_prefix}members AS mem ON (mem.id_member = m.id_member)
			LEFT JOIN {db_prefix}characters AS chars ON (chars.id_character = m.id_character)]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
		SELECT COALESCE(mem.real_name, m.poster_name) AS poster_name, m.poster_time, m.body, m.id_topic, m.subject,
			m.id_board, m.id_member, m.approved
		FROM {db_prefix}messages AS m
			INNER JOIN {db_prefix}topics AS t ON (t.id_topic = m.id_topic)]]></search>
			<add><![CDATA[
		SELECT COALESCE(chars.character_name, mem.real_name, m.poster_name) AS poster_name, m.poster_time, m.body, m.id_topic, m.subject,
			m.id_board, m.id_member, m.approved
		FROM {db_prefix}messages AS m
			LEFT JOIN {db_prefix}characters AS chars ON (m.id_character = chars.id_character)
			INNER JOIN {db_prefix}topics AS t ON (t.id_topic = m.id_topic)]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
				SELECT m.subject, COALESCE(mem.real_name, m.poster_name) AS poster_name, m.poster_time, m.body
				FROM {db_prefix}messages AS m
					INNER JOIN {db_prefix}boards AS b ON (b.id_board = m.id_board AND {query_see_board})]]></search>
			<add><![CDATA[
				SELECT m.subject, COALESCE(chars.character_name, mem.real_name, m.poster_name) AS poster_name, m.poster_time, m.body
				FROM {db_prefix}messages AS m
					LEFT JOIN {db_prefix}characters AS chars ON (m.id_character = chars.id_character)
					INNER JOIN {db_prefix}boards AS b ON (b.id_board = m.id_board AND {query_see_board})]]></add>
		</operation>
	</file>

	<!-- Now fix the board index -->
	<file name="$sourcedir/Subs-BoardIndex.php">
		<operation>
			<search position="replace"><![CDATA[
			m.subject, m.id_topic, COALESCE(mem.real_name, m.poster_name) AS real_name,]]></search>
			<add><![CDATA[
			m.subject, m.id_topic, chars.id_character, COALESCE(chars.character_name, mem.real_name, m.poster_name) AS real_name,]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
			LEFT JOIN {db_prefix}messages AS m ON (m.id_msg = b.id_last_msg)]]></search>
			<add><![CDATA[
			LEFT JOIN {db_prefix}messages AS m ON (m.id_msg = b.id_last_msg)
			LEFT JOIN {db_prefix}characters AS chars ON (m.id_character = chars.id_character)]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
				'href' => $row_board['poster_name'] != '' && !empty($row_board['id_member']) ? $scripturl . '?action=profile;u=' . $row_board['id_member'] : '',
				'link' => $row_board['poster_name'] != '' ? (!empty($row_board['id_member']) ? '<a href="' . $scripturl . '?action=profile;u=' . $row_board['id_member'] . '">' . $row_board['real_name'] . '</a>' : $row_board['real_name']) : $txt['not_applicable'],]]></search>
			<add><![CDATA[
				'href' => $row_board['poster_name'] != '' && !empty($row_board['id_member']) ? $scripturl . '?action=profile;u=' . $row_board['id_member'] . (!empty($row_board['id_character']) ? ';area=characters;char=' . $row_board['id_character'] : ''): '',
				'link' => $row_board['poster_name'] != '' ? (!empty($row_board['id_member']) ? '<a href="' . $scripturl . '?action=profile;u=' . $row_board['id_member'] . (!empty($row_board['id_character']) ? ';area=characters;char=' . $row_board['id_character'] : '') . '">' . $row_board['real_name'] . '</a>' : $row_board['real_name']) : $txt['not_applicable'],]]></add>
		</operation>
	</file>

	<!-- Fix the autosuggester -->
	<file name="$themedir/scripts/PersonalMessage.js">
		<operation>
			<search position="replace"><![CDATA[		sControlId: this.opt.sToControlId,
		sSearchType: 'member',]]></search>
			<add><![CDATA[		sControlId: this.opt.sToControlId,
		sSearchType: 'memberchar',]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[		sControlId: this.opt.sBccControlId,
		sSearchType: 'member',]]></search>
			<add><![CDATA[		sControlId: this.opt.sBccControlId,
		sSearchType: 'memberchar',]]></add>
		</operation>
	</file>

	<!-- Cleaning up the profile area -->
	<file name="$sourcedir/Profile-Modify.php">
		<operation>
			<search position="replace"><![CDATA[
			'avatar_choice', 'hr', 'personal_text', 'hr',
			'bday1', 'usertitle', 'signature', 'hr',]]></search>
			<add><![CDATA[
			'personal_text', 'hr', 'bday1', 'usertitle', 'hr',]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA['id_theme', 'smiley_set', 'hr',]]></search>
			<add><![CDATA['smiley_set', 'hr',]]></add>
		</operation>
	</file>
	<file name="$sourcedir/Profile-View.php">
		<operation>
			<search position="replace"><![CDATA[$action_text = $row['action'];

		// Parse BBC?]]></search>
			<add><![CDATA[$action_text = $row['action'];

		// Character related edit?
		if (!empty($extra['id_character']))
		{
			if (!empty($context['member']['characters'][$extra['id_character']]))
				$character_name = $context['member']['characters'][$extra['id_character']]['character_name'];
			else
				$character_name = $extra['character_name'];

			$action_text = sprintf($action_text, $character_name);
		}

		// Parse BBC?]]></add>
		</operation>
	</file>

	<!-- Moving that fscking logout button -->
	<file name="$themedir/index.template.php">
		<operation>
			<search position="replace"><![CDATA[
		// And now we're done.
		echo '
		</ul>';]]></search>
			<add><![CDATA[
		// And now we're done.
		echo '
			<li>
				<a href="', $scripturl, '?action=logout;', $context['session_var'], '=', $context['session_id'], '">', $txt['logout'], '</a>
			</li>
		</ul>';]]></add>
		</operation>
	</file>

	<!-- Marking boards as OOC -->
	<file name="$sourcedir/Load.php">
		<operation>
			<search position="replace"><![CDATA[b.child_level,
				b.id_theme, b.override_theme, b.count_posts, b.id_profile, b.redirect,]]></search>
			<add><![CDATA[b.child_level, b.in_character,
				b.id_theme, b.override_theme, b.count_posts, b.id_profile, b.redirect,]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA['recycle' => !empty($modSettings['recycle_enable']) && !empty($modSettings['recycle_board']) && $modSettings['recycle_board'] == $board,
				'posts_count' => empty($row['count_posts']),]]></search>
			<add><![CDATA['recycle' => !empty($modSettings['recycle_enable']) && !empty($modSettings['recycle_board']) && $modSettings['recycle_board'] == $board,
				'in_character' => !empty($row['in_character']),
				'posts_count' => empty($row['count_posts']),]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[// Remove all the permissions they shouldn't have ;).
	if (!empty($modSettings['permission_enable_deny']))
		$user_info['permissions'] = array_diff($user_info['permissions'], $removals);]]></search>
			<add><![CDATA[// Remove all the permissions they shouldn't have ;).
	if (!empty($modSettings['permission_enable_deny']))
		$user_info['permissions'] = array_diff($user_info['permissions'], $removals);

	// And if this is an OOC board, we might have to remove some permissions.
	$disable_posting = !empty($board_info['in_character']) && $user_info['char_is_main'];
	if ($disable_posting)
	{
		$user_info['permissions'] = array_diff($user_info['permissions'], array(
			'moderate_board',
			'approve_posts',
			'post_new',
			'post_unapproved_topics',
			'post_unapproved_replies_own',
			'post_unapproved_replies_any',
			'post_reply_own',
			'post_reply_any',
			'post_draft',
			'post_attachment',
			'modify_own',
			'modify_any',
			'modify_replies',
			'delete_own',
			'delete_any',
			'delete_replies',
			'merge_any',
			'split_any',
			'lock_own',
			'lock_any',
			'remove_own',
			'remove_any',
			'poll_vote',
			'poll_post',
			'poll_add_own',
			'poll_add_any',
			'poll_edit_own',
			'poll_edit_any',
			'poll_lock_own',
			'poll_lock_any',
			'poll_remove_own',
			'poll_remove_any',
			'post_unapproved_attachments',
			'post_attachment',
		));
	}]]></add>
		</operation>
	</file>
	<file name="$sourcedir/Subs-Boards.php">
		<operation>
			<search position="replace"><![CDATA[COALESCE(b.id_board, 0) AS id_board, b.id_parent, b.name AS board_name, b.description, b.child_level,]]></search>
			<add><![CDATA[COALESCE(b.id_board, 0) AS id_board, b.id_parent, b.name AS board_name, b.description, b.child_level, b.in_character,]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA['redirect' => $row['redirect'],
				'prev_board' => $prevBoard]]></search>
			<add><![CDATA['redirect' => $row['redirect'],
				'in_character' => $row['in_character'],
				'prev_board' => $prevBoard]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[if (isset($boardOptions['num_posts']))
	{
		$boardUpdates[] = 'num_posts = {int:num_posts}';
		$boardUpdateParameters['num_posts'] = (int) $boardOptions['num_posts'];
	}

	$id = $board_id;]]></search>
			<add><![CDATA[if (isset($boardOptions['num_posts']))
	{
		$boardUpdates[] = 'num_posts = {int:num_posts}';
		$boardUpdateParameters['num_posts'] = (int) $boardOptions['num_posts'];
	}

	if (isset($boardOptions['in_character']))
	{
		$boardUpdates[] = 'in_character = {int:in_character}';
		$boardUpdateParameters['in_character'] = !empty($boardOptions['in_character']) ? 1 : 0;
	}

	$id = $board_id;]]></add>
		</operation>
	</file>
	<file name="$sourcedir/ManageBoards.php">
		<operation>
			<search position="replace"><![CDATA['override_theme' => 0,
			'redirect' => '',]]></search>
			<add><![CDATA['override_theme' => 0,
			'in_character' => 1,
			'redirect' => '',]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[// Checkboxes....
		$boardOptions['posts_count'] = isset($_POST['count']);]]></search>
			<add><![CDATA[// Checkboxes....
		$boardOptions['in_character'] = !empty($_POST['in_character']);
		$boardOptions['posts_count'] = isset($_POST['count']);]]></add>
		</operation>
	</file>
	<file name="$themedir/ManageBoards.template.php">
		<operation>
			<search position="replace"><![CDATA[</dd>
					<dt>
						<strong>', $txt['permission_profile'], ':</strong><br>]]></search>
			<add><![CDATA[</dd>
					<dt>
						<strong>', $txt['board_in_character'], '</strong><br>
						<span class="smalltext">', $txt['board_in_character_desc'], '</span><br>
					</dt>
					<dd>
						<input type="checkbox" name="in_character"', $context['board']['in_character'] ? ' checked' : '', ' class="input_check">
					</dd>
					<dt>
						<strong>', $txt['permission_profile'], ':</strong><br>]]></add>
		</operation>
	</file>

	<!-- We also need to fix up searching. -->
	<file name="$sourcedir/Search.php">
		<operation>
			<search position="replace"><![CDATA[
				first_mem.id_member AS first_member_id, COALESCE(first_mem.real_name, first_m.poster_name) AS first_member_name,
				last_m.id_msg AS last_msg, last_m.poster_time AS last_poster_time, last_mem.id_member AS last_member_id,
				COALESCE(last_mem.real_name, last_m.poster_name) AS last_member_name, last_m.icon AS last_icon, last_m.subject AS last_subject,]]></search>
			<add><![CDATA[
				first_mem.id_member AS first_member_id, m.id_character, COALESCE(char_f.character_name, first_mem.real_name, first_m.poster_name) AS first_member_name,
				last_m.id_msg AS last_msg, last_m.poster_time AS last_poster_time, last_mem.id_member AS last_member_id,
				COALESCE(char_l.character_name, last_mem.real_name, last_m.poster_name) AS last_member_name, last_m.icon AS last_icon, last_m.subject AS last_subject,]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
				INNER JOIN {db_prefix}messages AS first_m ON (first_m.id_msg = t.id_first_msg)
				INNER JOIN {db_prefix}messages AS last_m ON (last_m.id_msg = t.id_last_msg)]]></search>
			<add><![CDATA[
				INNER JOIN {db_prefix}messages AS first_m ON (first_m.id_msg = t.id_first_msg)
				INNER JOIN {db_prefix}messages AS last_m ON (last_m.id_msg = t.id_last_msg)
				LEFT JOIN {db_prefix}characters AS char_f ON (first_m.id_character = char_f.id_character)
				LEFT JOIN {db_prefix}characters AS char_l ON (last_m.id_character = char_l.id_character)]]></add>
		</operation>
	</file>

	<!-- Allow switching between characters on a post -->
	<file name="$themedir/Display.template.php">
		<operation>
			<search position="replace"><![CDATA[// What about splitting it off the rest of the topic?]]></search>
			<add><![CDATA[// What about if we want to post to multiple characters?
		if ($message['can_switch_char'])
		{
			echo '
											<li>
												<a href="#" onclick="return false">
													<span class="generic_icons people"></span> ', $txt['switch_to_char_menu'], '
												</a>
												<ul>';
			foreach ($message['possible_characters'] as $char_id => $char_name) {
				echo '
													<li><a href=" ', $scripturl, '?action=reattributepost;topic=', $context['current_topic'], ';msg=', $message['id'], ';char=', $char_id, ';', $context['session_var'], '=', $context['session_id'], '">', $char_name, '</a></li>';
			}
			echo '
												</ul>
											</li>';
		}

		// What about splitting it off the rest of the topic?]]></add>
		</operation>
	</file>

	<!-- Now to collect registration details -->
	<file name="$themedir/Register.template.php">
		<operation>
			<search position="replace"><![CDATA[							<input type="text" name="email" id="smf_autov_reserve1" size="30" tabindex="', $context['tabindex']++, '" value="', isset($context['email']) ? $context['email'] : '', '" class="input_text">
						</dd>
					</dl>
					<dl class="register_form" id="password1_group">]]></search>
			<add><![CDATA[							<input type="text" name="email" id="smf_autov_reserve1" size="30" tabindex="', $context['tabindex']++, '" value="', isset($context['email']) ? $context['email'] : '', '" class="input_text">
						</dd>
						<dt><strong><label for="real_name_box">', $txt['char_register_nickname'], ':</label></strong></dt>
						<dd>
							<input type="text" id="real_name_box" name="real_name" size="30" tabindex="', $context['tabindex']++, '" maxlength="200" value="', isset($context['real_name']) ? $context['real_name'] : '', '" class="input_text">
						</dd>
						<dt><strong><label for="first_char_box">', $txt['char_register_charname'], ':</label></strong></dt>
						<dd>
							<input type="text" id="first_char_box" name="first_char" size="30" tabindex="', $context['tabindex']++, '" maxlength="200" value="', isset($context['first_char']) ? $context['first_char'] : '', '" class="input_text">
						</dd>
					</dl>
					<dl class="register_form" id="password1_group">]]></add>
		</operation>
	</file>
	<file name="$sourcedir/Register.php">
		<operation>
			<search position="replace"><![CDATA[	$possible_strings = array(
		'birthdate',]]></search>
			<add><![CDATA[	$possible_strings = array(
		'first_char',
		'birthdate',]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[	$context += array(
		'username' => isset($_POST['user']) ? $smcFunc['htmlspecialchars']($_POST['user']) : '',
		'email' => isset($_POST['email']) ? $smcFunc['htmlspecialchars']($_POST['email']) : '',
		'notify_announcements' => !empty($_POST['notify_announcements']) ? 1 : 0,
	);]]></search>
			<add><![CDATA[	$context += array(
		'username' => isset($_POST['user']) ? $smcFunc['htmlspecialchars']($_POST['user']) : '',
		'real_name' => isset($_POST['real_name']) ? $smcFunc['htmlspecialchars']($_POST['real_name']) : '',
		'first_char' => isset($_POST['first_char']) ? $smcFunc['htmlspecialchars']($_POST['first_char']) : '',
		'email' => isset($_POST['email']) ? $smcFunc['htmlspecialchars']($_POST['email']) : '',
		'notify_announcements' => !empty($_POST['notify_announcements']) ? 1 : 0,
	);]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[	// Validation... even if we're not a mall.
	if (isset($_POST['real_name']) && (allowedTo('profile_displayed_name') || allowedTo('moderate_forum')))]]></search>
			<add><![CDATA[	// Validation... even if we're not a mall.
	if (isset($_POST['real_name']))]]></add>
		</operation>
	</file>

	<!-- And fix the maintenance system -->
	<file name="$sourcedir/ManageMaintenance.php">
		<operation>
			<search position="replace"><![CDATA[	// Continue?
	if ($total_rows == $increment)]]></search>
			<add><![CDATA[	// Now to fix the post counts for characters.
	$request = $smcFunc['db_query']('', '
		SELECT /*!40001 SQL_NO_CACHE */ m.id_character, COUNT(m.id_character) AS posts
		FROM ({db_prefix}messages AS m, {db_prefix}boards AS b)
		WHERE m.id_character != {int:zero}
			AND b.count_posts = {int:zero}
			AND m.id_board = b.id_board ' . (!empty($modSettings['recycle_enable']) ? '
			AND b.id_board != {int:recycle}' : '') . '
		GROUP BY m.id_character
		LIMIT {int:start}, {int:number}',
		array(
			'start' => $_REQUEST['start'],
			'number' => $increment,
			'recycle' => $modSettings['recycle_board'],
			'zero' => 0,
		)
	);
	$total_rows = $smcFunc['db_num_rows']($request);

	// Update the post count for this group
	while ($row = $smcFunc['db_fetch_assoc']($request))
	{
		$smcFunc['db_query']('', '
			UPDATE {db_prefix}characters
			SET posts = {int:posts}
			WHERE id_character = {int:row}',
			array(
				'row' => $row['id_character'],
				'posts' => $row['posts'],
			)
		);
	}
	$smcFunc['db_free_result']($request);

	// Continue?
	if ($total_rows == $increment)]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[	// all done]]></search>
			<add><![CDATA[	// now to redo the deliquents on the post count front for characters
	$createTemporaryChar = $smcFunc['db_query']('', '
		CREATE TEMPORARY TABLE {db_prefix}tmp_maint_recountcharposts (
			id_character int(10) unsigned NOT NULL default {string:string_zero},
			PRIMARY KEY (id_member)
		)
		SELECT m.id_character
		FROM ({db_prefix}messages AS m,{db_prefix}boards AS b)
		WHERE m.id_character != {int:zero}
			AND b.count_posts = {int:zero}
			AND m.id_board = b.id_board ' . (!empty($modSettings['recycle_enable']) ? '
			AND b.id_board != {int:recycle}' : '') . '
		GROUP BY m.id_character',
		array(
			'zero' => 0,
			'string_zero' => '0',
			'db_error_skip' => true,
			'recycle' => !empty($modSettings['recycle_board']) ? $modSettings['recycle_board'] : 0,
		)
	) !== false;

	if ($createTemporaryChar)
	{
		// outer join the characters table on the temporary table finding the members that have a post count but no posts in the message table
		$request = $smcFunc['db_query']('', '
			SELECT chars.id_character, chars.posts
			FROM {db_prefix}characters AS chars
			LEFT OUTER JOIN {db_prefix}tmp_maint_recountcharposts AS res
			ON res.id_character = chars.id_character
			WHERE res.id_character IS null
				AND chars.posts != {int:zero}',
			array(
				'zero' => 0,
			)
		);

		// set the post count to zero for any delinquents we may have found
		while ($row = $smcFunc['db_fetch_assoc']($request))
		{
			$smcFunc['db_query']('', '
				UPDATE {db_prefix}characters
				SET posts = {int:zero}
				WHERE id_character = {int:row}',
				array(
					'row' => $row['id_character'],
					'zero' => 0,
				)
			);
		}
		$smcFunc['db_free_result']($request);
	}

	// all done]]></add>
		</operation>
	</file>

	<!-- Character-level membergroups are... interesting. -->
	<file name="$sourcedir/ManageMembergroups.php">
		<operation>
			<search position="replace"><![CDATA[				'sort' => array(
					'default' => 'CASE WHEN mg.id_group < 4 THEN mg.id_group ELSE 4 END, mg.group_name',
					'reverse' => 'CASE WHEN mg.id_group < 4 THEN mg.id_group ELSE 4 END, mg.group_name DESC',
				),
			),
			'icons' => array(]]></search>
			<add><![CDATA[				'sort' => array(
					'default' => 'CASE WHEN mg.id_group < 4 THEN mg.id_group ELSE 4 END, mg.group_name',
					'reverse' => 'CASE WHEN mg.id_group < 4 THEN mg.id_group ELSE 4 END, mg.group_name DESC',
				),
			),
			'level' => array(
				'header' => array(
					'value' => $txt['char_group_level'],
				),
				'data' => array(
					'function' => function($rowData) use ($txt)
					{
						return empty($rowData['is_character']) ? $txt['char_group_level_acct'] : $txt['char_group_level_char'];
					},
				),
			),
			'icons' => array(]]></add>
		</operation>
	</file>
</modification>
